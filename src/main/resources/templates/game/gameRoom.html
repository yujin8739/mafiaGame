<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/common/header.css}" />
    <link rel="stylesheet" th:href="@{/css/common/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/chat/chat.css}" />
    <link rel="stylesheet" th:href="@{/css/index.css}" />
    <link rel="stylesheet" th:href="@{/css/job/playerPanel.css}" />
    <link rel="stylesheet" th:href="@{/css/game/phoneModal.css}" />
    <title>ìš°ì£¼í•˜ë§ˆí”¼ì•„ ê²Œì„ë£¸</title>
    <style>
        #voiceRemoteContainer audio {
            display: block;
            margin: 4px 0;
        }
    </style>
</head>

<body>
    <div th:replace="~{common/header :: header}"></div>

    <div class="home-wrapper">
        <div class="sideAD"></div>

        <div th:replace="~{chat/gameMainChat :: gameMainChat}"></div>

        <div class="player-panel-container" style="position: relative;">
            <div id="controlPanel">
                <div th:replace="~{game/job/playerPanel :: playerPanelFragment}"></div>
                <div class="readyDiv" style="display: flex; align-items: center;">
                    <button class="startBtn" id="startBtn" onclick="startGame()">Start</button>
                    <button class="readyBtn" id="readyBtn" onclick="ready()">Ready</button>
                    <div id="readyCount">Ready: 0</div>
                </div>
                <div id="gamePhaseContainer" class="game-phase">
                    <div id="dayCount" class="text-lg font-semibold text-gray-700">ì¼ì°¨ : 0</div>
                    <div id="killCount" class="text-lg font-semibold text-gray-700">íˆ¬í‘œ : 0</div>
                    <div id="phaseDisplay" class="text-xl font-bold text-indigo-600">í˜„ì¬ ë‹¨ê³„: -</div>
                    <div id="timerDisplay" class="text-lg text-gray-500">ë‚¨ì€ ì‹œê°„: - ì´ˆ</div>
                    <button id="startVoiceBtn">ğŸ™ ìŒì„±ì±„íŒ… ì‹œì‘</button>
                    <button id="stopVoiceBtn">ğŸ”‡ ìŒì„±ì±„íŒ… ì¢…ë£Œ</button>
                    <button id="muteVoiceBtn"> ğŸ”ˆ </button>
                </div>
            </div>

            <div id="voiceRemoteContainer"></div>

            <div th:replace="game/phoneModal :: phoneModal" id="phoneModal"></div>
            <button id="togglePhoneModalBtn" type="button" style="margin-top: 10px;">íœ´ëŒ€í° ì—´ê¸°</button>
        </div>
    </div>

    <div th:replace="~{common/footer :: footer}"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        /* ==========================
           ì„œë²„ í…œí”Œë¦¿ ë³€ìˆ˜, ì´ˆê¸° ë³€ìˆ˜
        ========================== */
        const roomNo = /*[[${roomNo}]]*/ 0;
        let isGaming = false;
        let isReady = false;
        let readyCount = 0;
        let nickName = /*[[${loginUser.nickName}]]*/ 'ìµëª…';
        let userName = /*[[${loginUser.userName}]]*/ '';
        let room = /*[[${room}]]*/ null;
        let dayNo = room ? room.dayNo : 0;
        isGaming = room && room.isGaming === 'Y';
        const isHost = (room && room.master === userName);
        const chatArea = document.querySelector('#chatArea');
        const startBtn = document.getElementById('startBtn');
        const readyBtn = document.getElementById('readyBtn');
		const phoneModal = document.getElementById("phoneModal");
		const toggleBtn = document.getElementById("togglePhoneModalBtn");
		const closeBtn = phoneModal.querySelector("#closePhoneModalBtn");
		const chatInput = document.getElementById('chat');
		const hackBtn = document.getElementById("hackBtn");
		
        //ë¸”ë¡ê²€ìƒ‰ìš©
        let currentPage = 1; // í˜„ì¬ ëª‡ ë²ˆì§¸ ë¸”ë¡ì„ ë³´ê³  ìˆëŠ”ì§€
        const pageSize = 30; // í•œ ë¸”ë¡ì— ëª‡ ê°œì˜ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¬ì§€
        let isLoading = false;
        let isLastPage = false;
        let isFirstLoad = true;

        //ê²Œì„ìš©
        var job = 'none';
        let jobObj;
        var isNight = false;
        let timerId = null;
        
        //ì•Œë¦¼ ì¤„ì§€ í™•ì¸ìš©(ì‹œê°„ë¶€ì¡±ìœ¼ë¡œ ì´ëŸ°ì‹ìœ¼ë¡œ ë§Œë“¬)
        let isStart = false;

        /* (ìš”ì²­: remoteStream ì‚­ì œí•˜ì§€ ë§ê³  ìœ ì§€) */
        const remoteStream = new MediaStream(); // (í˜„ì¬ ì‚¬ìš© X / DEPRECATED ìš©ë„)

        /* ==========================
           ìœ ì € ë° ë°© ì´ˆê¸° ìƒíƒœ ì ê²€
        ========================== */
        if (!room || !room.roomNo) {
            alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
            window.location.href = /*[[ @{/} ]]*/ '/';
        }
        const userListArray = room && room.userList ? JSON.parse(room.userList) : [];
        if (isGaming && !userListArray.includes(userName)) {
            alert('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
            window.location.href = /*[[ @{/} ]]*/ '/';
        } else if (isGaming) {
            sendBtn.disabled = true;
            sendBtn.classList.add('disabled-btn');

            chatInput.disabled = true;
            chatInput.placeholder = "ì¬ì…ì¥ì‹œ ë‹¤ìŒë²ˆ ë‚®ê¹Œì§€ ì±„íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
        }
        if (userListArray.length >= room.headCount && !userListArray.includes(userName)) {
            alert('ì´ë¯¸ ë°©ì´ ê½‰ì°¼ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
            window.location.href = /*[[ @{/} ]]*/ '/';
        }
        if (room.master === userName || room.master === null) {
            startBtn.style.display = 'block';
            readyBtn.style.display = 'none';
        }
        if (isGaming) {
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('chat').disabled = true;
            document.getElementById('chat').placeholder = 'ì¬ì…ì¥ì‹œ ë‹¤ìŒ ë‚®ê¹Œì§€ ì±„íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.';
        }

        toggleBtn.addEventListener("click", () => {
            if (phoneModal.style.display === "none" || phoneModal.style.display === "") {
                phoneModal.style.display = "block";
                togglePhoneModalBtn.style.display = "none";
                controlPanel.style.display = "none";
            } else {
                phoneModal.style.display = "none";
                togglePhoneModalBtn.style.display = "block";
                controlPanel.style.display = "block";
            }
        });

        closeBtn.addEventListener("click", () => {
            phoneModal.style.display = "none";
            togglePhoneModalBtn.style.display = "block";
            controlPanel.style.display = "block";
        });

        chatLoad(job);

        /* ==========================
           WebSocket ì—°ê²° ë° ì¬ì—°ê²° ì²˜ë¦¬
        ========================== */
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function setupWebRTCSignaling() {
            if (isHost) {
                safeSend({ type: 'rtcHello', userName: nickName, roomNo: roomNo });
            }
        }
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
            socket = new WebSocket(protocol + location.host + '/chat/gameMainChat?roomNo=' + roomNo);

            socket.onopen = () => {
                console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
                reconnectAttempts = 0;
                sendEnterMessage();
                setupWebRTCSignaling();
            };
            socket.onerror = err => console.error('âŒ WebSocket ì˜¤ë¥˜', err);
            socket.onclose = () => {
                console.warn('âš ï¸ WebSocket ëŠê¹€');
                disableGameUI();
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log('ğŸ”„ ì¬ì—°ê²° ì‹œë„ #' + reconnectAttempts);
                        connectWebSocket();
                        //ë°© ì‚­ì œë˜ì—ˆì„ë•Œ ì†Œìº£ ë¬´í•œ ì¬ì ‘ì† ë°©ì§€
                        if (!room || !room.roomNo) {
                            alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
                            window.location.href = /*[[ @{/} ]]*/ '/';
                        }
                        if (userListArray.length >= room.headCount && !userListArray.includes(userName)) {
                            alert('ì´ë¯¸ ë°©ì´ ê½‰ì°¼ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
                            window.location.href = /*[[ @{/} ]]*/ '/';
                        }
                        if (isGaming && !userListArray.includes(userName)) {
                            alert('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²Œì„ì— ì ‘ì†í•´ì£¼ì„¸ìš”');
                            window.location.href = /*[[ @{/} ]]*/ '/';
                        }
                    }, Math.min(5000, reconnectAttempts * 1000));
                } else {
                    alert('ì„œë²„ ì¬ì—°ê²° ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                }
            };
            socket.onmessage = event => {
                const msgData = JSON.parse(event.data);
                handleSocketMessage(msgData);
            };
        }
        connectWebSocket();

        function safeSend(obj) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(obj));
            } else {
                console.warn('WebSocketì´ ì—´ë ¤ìˆì§€ ì•Šì•„ ì „ì†¡ ë¶ˆê°€', obj);
            }
        }
        function sendEnterMessage() {
            safeSend({
                type: 'enter',
                userName: nickName,
                msg: nickName + 'ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.',
                roomNo: roomNo
            });
        }

        /* ==========================
           í…ìŠ¤íŠ¸ ì±„íŒ… WebRTC ì‹œê·¸ë„ë§
        ========================== */
        let peers = {};
        let dataChannels = {};

        async function createPeerConnection(peerUser, isInitiator) {
            const pc = new RTCPeerConnection();
            peers[peerUser] = pc;

            pc.onicecandidate = e => {
                if (e.candidate) {
                    safeSend({ type: 'rtcIce', target: peerUser, candidate: e.candidate, from: userName });
                }
            };
            if (isInitiator) {
                const dc = pc.createDataChannel('chat');
                dataChannels[peerUser] = dc;
                setupDataChannel(peerUser, dc);
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                safeSend({ type: 'rtcOffer', target: peerUser, sdp: offer, from: userName });
            } else {
                pc.ondatachannel = e => {
                    const dc = e.channel;
                    dataChannels[peerUser] = dc;
                    setupDataChannel(peerUser, dc);
                };
            }
        }
        function setupDataChannel(peerUser, dc) {
            dc.onopen = () => console.log('DataChannel open:', peerUser);
            dc.onmessage = e => handleRTCMessage(JSON.parse(e.data));
            dc.onclose = () => console.log('DataChannel close:', peerUser);
        }
        function handleRTCMessage(msgData) {
            const wasAtBottom = isScrolledToBottom(chatArea);
            const div = document.createElement('div');
            reciveMsg(msgData, div);
            chatArea.appendChild(div);
            scrollIfNeeded(wasAtBottom);
        }

        async function onRtcHello(sig) {
            if (!isHost) return;
            await createPeerConnection(sig.from, true);
        }
        async function onRtcOffer(sig) {
            if (isHost) return;
            if (!peers[sig.from]) await createPeerConnection(sig.from, false);
            const pc = peers[sig.from];
            await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            safeSend({ type: 'rtcAnswer', target: sig.from, sdp: answer, from: userName });
        }
        async function onRtcAnswer(sig) {
            const pc = peers[sig.from];
            if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        }
        function onRtcIce(sig) {
            const pc = peers[sig.from];
            if (pc) {
                try {
                    pc.addIceCandidate(new RTCIceCandidate(sig.candidate));
                } catch (e) {
                    console.warn('ICE candidate ì¶”ê°€ ì‹¤íŒ¨', e);
                }
            }
        }

        /* ==========================
           ì±„íŒ… ì „ì†¡
        ========================== */
        function sendChatMessage(text) {
            const msg = { type: 'chat', userName: nickName, msg: text, roomNo: roomNo };
            let sent = false;
            Object.entries(dataChannels).forEach(([peerUser, dc]) => {
                if (dc.readyState === 'open') {
                    dc.send(JSON.stringify(msg));
                    sent = true;
                }
            });
            if (!sent) safeSend(msg);
        }
        document.getElementById('sendBtn').addEventListener('click', () => {
            const val = chatInput.value.trim();
            if (val.length > 0) {
                sendChatMessage(val);
                chatInput.value = '';
            }
        });
        document.getElementById('chat').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('sendBtn').click();
            }
        });

        /* ==========================
           ê²Œì„ ì¤€ë¹„/ì‹œì‘
        ========================== */
        function ready() {
            isReady = !isReady;
            const type = isReady ? 'ready' : 'unReady';
            const msg = isReady ? nickName + 'ë‹˜ì´ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.' : nickName + 'ë‹˜ì´ ì¤€ë¹„ í•´ì œí–ˆìŠµë‹ˆë‹¤.';
            safeSend({ type, userName: nickName, msg, roomNo });
        }
		
        function startGame() {
            if (readyCount === (document.querySelectorAll('.slot').length - 1)) {
                safeSend({ type: 'start', userName: 'ì‹œìŠ¤í…œ', msg: 'ê²Œì„ ì‹œì‘í•©ë‹ˆë‹¤.', roomNo });
            } else {
                alert('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì–´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }

        /* ==========================
           ê²Œì„ ë©”ì‹œì§€ ë° ìƒíƒœ ì²˜ë¦¬
        ========================== */
        function handleSocketMessage(msgData) {
            // ìŒì„± ë©”ì‹œì§€ ìš°ì„  ì²˜ë¦¬
            if (msgData.type.startsWith('voice')) {
                handleVoiceMsg(msgData);
                return;
            }
            switch (msgData.type) {
                case 'rtcHello': onRtcHello(msgData); break;
                case 'rtcOffer': onRtcOffer(msgData); break;
                case 'rtcAnswer': onRtcAnswer(msgData); break;
                case 'rtcIce': onRtcIce(msgData); break;
                case 'ready':
                case 'unReady':
                    setReadyCount();
                    addEtcMsg(msgData);
                    break;
                case 'start':
                    setStart();
                    loadHintList(roomNo);
                    addEtcMsg(msgData);
                    break;
                case 'enter':
                case 'leave':
                    if (isGaming) {
                        setStart();
                        loadHintList(roomNo);
                    }
                    roomReloadToUserLoad();
                    addEtcMsg(msgData);
                    break;
                case 'phase':
                    setTimer(msgData.phase, msgData.remaining);
                    break;
                case 'HACK': 
                	loadHintList(roomNo);
                	addEtcMsg(msgData);
                	break;
                case 'MAFIA_WIN': 
                	msgData.msg = 'ë§ˆí”¼ì•„ì˜ ìŠ¹ë¦¬! ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                	setStop();
                    addEtcMsg(msgData);
                case 'CITIZEN_WIN':
                	msgData.msg = 'ì‹œë¯¼ì˜ ìŠ¹ë¦¬! ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                	//jobObj.
                	setStop();
                    addEtcMsg(msgData);
                case 'NEUTRALITY_WIN':
                	msgData.msg = 'ì¤‘ë¦½ì˜ ìŠ¹ë¦¬! ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                    setStop();
                    addEtcMsg(msgData);
                    break;
                default:
                    displayChatMessage(msgData);
                    break;
            }
        }

        function addEtcMsg(msgData) {
            const wasAtBottom = isScrolledToBottom(chatArea);
            const div = document.createElement("div");
            reciveMsg(msgData, div);
            chatArea.appendChild(div);
            scrollIfNeeded(wasAtBottom);
        }

        function displayChatMessage(msgData) {
            const wasAtBottom = isScrolledToBottom(chatArea);
            const div = document.createElement("div");

            if (msgData.type && msgData.type.includes("death")) {
                if (job !== "ghost" && job !== "mafiaGhost" && job !== "spiritualists") {
                    return;
                } else {
                    const typeDiv = document.createElement("div");
                    typeDiv.classList.add("type-Text");
                    typeDiv.textContent = "ã€ì‚¬ë§ìã€";
                    div.appendChild(typeDiv);
                }
            } else if (msgData.type && msgData.type === "mafia") {
                if (job !== "mafia") {
                    return;
                } else {
                    const typeDiv = document.createElement("div");
                    typeDiv.classList.add("type-Text");
                    typeDiv.textContent = "ã€ë§ˆí”¼ì•„ã€";
                    div.appendChild(typeDiv);
                }
            }

            reciveMsg(msgData, div);
            chatArea.appendChild(div);
            scrollIfNeeded(wasAtBottom);
        }

        function setReadyCount() {
            $.ajax({
                url: '/room/readyCount',
                data: { roomNo },
                success: function (length) {
                    readyCount = length;
                    document.getElementById('readyCount').innerText = 'Ready: ' + length + '/' + (document.querySelectorAll('.slot').length - 1);
                }
            });
        }
        function setStart() {
            isGaming = true;
            document.querySelectorAll('.readyDiv').forEach(div => div.style.display = 'none');

            $.ajax({
                url: '/room/getJob',
                data: { roomNo: roomNo },
                success: function (myJob) {
                    jobObj = myJob;
                    job = myJob.jobName;
                    chatLoad(job);
                    if (!isStart) {
                        alert("ë‹¹ì‹ ì˜ ì§ì—…ì€ " + myJob.jobVisible + "ì…ë‹ˆë‹¤.");
                        isStart = true;
                        if(job==="hacker") {
                        	//ì§ì—…ì´ í•´ì»¤ë©´ ë³´ì—¬ì£¼ê¸°   
                        	hackBtn.style.display = "inline-block";
                        }
                    }
                    console.log();
                }
            })
        }
/*         function setStop() {
            isGaming = false;
            roomReload();
            
            
            enableGameUI();
        }
         */
		function setStop() {
			isStart = false;
			isGaming = false;
			jobObj = null;
			job = 'none';
			roomReload();
			
			sendBtn.disabled = false; 
			sendBtn.classList.remove('disabled-btn'); 

			chatInput.disabled = false; 
			chatInput.placeholder = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"; 
		}
        function roomReload() {
            $.ajax({
                url: '/room/reloadRoom',
                data: { roomNo },
                success: function (newRoom) {
                    room = newRoom;
                    dayNo = newRoom.dayNo;
                    document.getElementById('dayCount').innerText = 'ì¼ì°¨ : ' + dayNo + 'ì¼';
                }
            });
        }

        function roomReloadToUserLoad() {
            $.ajax({
                url: '/room/roomReloadToUserLoad',
                data: { roomNo },
                success: function (newRoom) {
                    userLoad(newRoom);
                }
            });
        }
        function userLoad(room) {
        	console.log(room.userList);
            $.ajax({
                url: '/room/userNickList',
                data: { userList: room.userList },
                success: function (userNickList) {
                	console.log(userNickList)
                    setUserNick(userNickList);
                    $.ajax({
                        url: '/room/userDeathList',
                        data: { roomNo },
                        success: function (deathList) {
                            loadUser(deathList);
                        }
                    });
                }
            });
        }

        /* ==========================
           ìŒì„± ì±„íŒ… ê¸°ëŠ¥ - ë©€í‹°íŒŒí‹° WebRTC
        ========================== */
        const voiceState = {
            localStream: null,
            peers: {},        // userName -> RTCPeerConnection
            remoteAudioEls: {},// userName -> HTMLAudioElement
            localMuted: false,
            isHost: isHost,
            isVoiceStarted: false,
            offered: {}       // === NEW: Hostê°€ Offer ë³´ë‚¸ ì‚¬ìš©ì ê¸°ë¡
        };
        const voiceUI = {
            startBtn: document.getElementById('startVoiceBtn'),
            stopBtn: document.getElementById('stopVoiceBtn'),
            muteBtn: document.getElementById('muteVoiceBtn'),
            container: document.getElementById('voiceRemoteContainer')
        };

        voiceUI.startBtn.onclick = startVoiceChat;
        voiceUI.stopBtn.onclick = stopVoiceChat;
        voiceUI.muteBtn.onclick = toggleMute;

        // =======================================================
        // === âœ¨ [ìˆ˜ì •ëœ ë¶€ë¶„] START: startVoiceChat í•¨ìˆ˜ ìˆ˜ì • âœ¨ ===
        // =======================================================
        async function startVoiceChat() {
            if (voiceState.isVoiceStarted) return;

            try {
                // 1. (í•µì‹¬ ìˆ˜ì •) `await`ë¥¼ ì‚¬ìš©í•´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì„ ì™„ì „íˆ ë°›ì•„ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                // ì´ê²ƒì´ ë³´ì¥ë˜ì–´ì•¼ë§Œ ë‹¤ë¥¸ ìœ ì €ì™€ì˜ ì—°ê²°(PeerConnection) ì‹œ ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì •ìƒì ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                voiceState.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                console.log("âœ… localStream íšë“:", voiceState.localStream);

                // ë§ˆì´í¬ ê¶Œí•œì€ í—ˆìš©í–ˆìœ¼ë‚˜, ì‹¤ì œ ì˜¤ë””ì˜¤ íŠ¸ë™ì´ ì—†ëŠ” ê²½ìš°ì— ëŒ€í•œ ì˜ˆì™¸ì²˜ë¦¬
                if (voiceState.localStream.getAudioTracks().length === 0) {
                    alert("ì—°ê²°ëœ ë§ˆì´í¬ ì¥ì¹˜ê°€ ì—†ê±°ë‚˜ ì¸ì‹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¥ì¹˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    console.warn("âš ï¸ ì˜¤ë””ì˜¤ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤ (ì¥ì¹˜/ê¶Œí•œ ë¬¸ì œ)");
                    voiceState.localStream = null; // ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì´ˆê¸°í™”
                    return; // í•¨ìˆ˜ ì¢…ë£Œ
                }

                // ë¡œì»¬ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ë¯¸ë¦¬ë³´ê¸° (ìì‹ ì—ê²ŒëŠ” ìŒì†Œê±° ìƒíƒœë¡œ)
                let localPrev = document.getElementById('localAudio');
                if (!localPrev) {
                    localPrev = document.createElement('audio');
                    localPrev.id = 'localAudio';
                    localPrev.autoplay = true;
                    localPrev.muted = true;
                    localPrev.playsInline = true;
                    document.getElementById('voiceRemoteContainer').appendChild(localPrev);
                }
                localPrev.srcObject = voiceState.localStream;
                localPrev.play().catch(e => console.warn("ë¡œì»¬ í”„ë¦¬ë·° ì¬ìƒ ì‹¤íŒ¨:", e));

                // 2. (ìˆ˜ì •) ìŠ¤íŠ¸ë¦¼ì„ ì„±ê³µì ìœ¼ë¡œ ì–»ì€ í›„ì— ìƒíƒœë¥¼ ë³€ê²½í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                voiceState.isVoiceStarted = true;
                voiceUI.startBtn.style.display = "none";   // startBtn ìˆ¨ê¹€
                voiceUI.stopBtn.style.display = "inline-block"; // stopBtn í‘œì‹œ
                voiceUI.muteBtn.style.display = "inline-block"; // muteBtn í‘œ

                // 3. (ìˆ˜ì •) ëª¨ë“  ì„¤ì •ì´ ëë‚œ í›„, ì‹œê·¸ë„ë§ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
                if (voiceState.isHost) {
                    // ë°©ì¥ì€ ë³¸ì¸ì´ ì‹œì‘í–ˆë‹¤ëŠ” ì‹ í˜¸ë§Œ ë³´ë‚´ê³ , ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ë“¤ì˜ 'voiceReady'ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                    safeSend({ type: 'voiceHostStart', userName, roomNo });
                } else {
                    // í´ë¼ì´ì–¸íŠ¸ëŠ” ë°©ì¥ì—ê²Œ ì—°ê²° ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ ì•Œë¦½ë‹ˆë‹¤.
                    safeSend({ type: 'voiceReady', userName, roomNo });
                }

            } catch (e) {
                console.error("âŒ startVoiceChat ì˜¤ë¥˜:", e);
                // ì‚¬ìš©ìì—ê²Œ ë” ì¹œì ˆí•œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
                if (e.name === "NotAllowedError" || e.name === "PermissionDeniedError") {
                    alert('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                } else if (e.name === "NotFoundError" || e.name === "DevicesNotFoundError") {
                    alert('ì‚¬ìš© ê°€ëŠ¥í•œ ë§ˆì´í¬ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë§ˆì´í¬ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                // ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì›ë³µ
                voiceState.isVoiceStarted = false;
                voiceState.localStream = null;
            }
        }
        // =====================================================
        // === âœ¨ [ìˆ˜ì •ëœ ë¶€ë¶„] END: startVoiceChat í•¨ìˆ˜ ìˆ˜ì • âœ¨ ===
        // =====================================================

        function stopVoiceChat() {
            if (!voiceState.isVoiceStarted) return;
            voiceState.isVoiceStarted = false;

            if (voiceState.localStream) {
                voiceState.localStream.getTracks().forEach(t => t.stop());
                voiceState.localStream = null;
            }
            clearVoiceConnections();

            // ë²„íŠ¼ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° ì „í™˜
            voiceUI.startBtn.style.display = "inline-block"; // ë‹¤ì‹œ ë³´ì´ê²Œ
            voiceUI.stopBtn.style.display = "none";          // ìˆ¨ê¹€
            voiceUI.muteBtn.style.display = "none";          // ìˆ¨ê¹€

            if (voiceState.isHost) {
                safeSend({ type: 'voiceHostStop', userName, roomNo });
            }
        }

        function toggleMute() {
            if (!voiceState.localStream) return;
            voiceState.localMuted = !voiceState.localMuted;
            voiceState.localStream.getAudioTracks().forEach(track => track.enabled = !voiceState.localMuted);
            voiceUI.muteBtn.textContent = voiceState.localMuted ? ' ğŸ”‡ ' : ' ğŸ”ˆ ';
            safeSend({ type: voiceState.localMuted ? 'voiceMute' : 'voiceUnmute', userName, roomNo });
        }

        function clearVoiceConnections() {
            for (const peerUser in voiceState.peers) {
                const pc = voiceState.peers[peerUser];
                if (pc) pc.close();
            }
            voiceState.peers = {};
            voiceState.offered = {};
            for (const key in voiceState.remoteAudioEls) {
                const el = voiceState.remoteAudioEls[key];
                if (el && el.parentNode) el.parentNode.removeChild(el);
            }
            voiceState.remoteAudioEls = {};
            const localAudio = document.getElementById('localAudio');
            if (localAudio && localAudio.parentNode) localAudio.parentNode.removeChild(localAudio);
        }

        /* -------- ìŒì„± ì‹œê·¸ë„ ì²˜ë¦¬ Offer / Answer / Candidate -------- */
        async function onVoiceOffer(msg) {
            if (!voiceState.isVoiceStarted) {
                console.warn("ğŸ”¸ ì•„ì§ startVoiceChat í•˜ì§€ ì•Šì•„ Offer ë¬´ì‹œ");
                return;
            }
            const fromUser = msg.from;
            const pc = createVoicePeerConnection(fromUser);

            if (pc.remoteDescription) {
                console.warn("ì´ë¯¸ remoteDescription ìˆìŒ â†’ ì¤‘ë³µ Offer ë¬´ì‹œ");
                return;
            }

            try {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                console.log("âœ… Offer SDP ì ìš©:", fromUser);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                safeSend({ type: 'voiceAnswer', target: fromUser, sdp: answer, from: userName });
                console.log("ğŸ“¨ Answer ì „ì†¡ â†’", fromUser);
            } catch (e) {
                console.error("âŒ Offer ì²˜ë¦¬ ì‹¤íŒ¨:", e);
            }
        }

        async function onVoiceAnswer(msg) {
            const fromUser = msg.from;
            const pc = voiceState.peers[fromUser];
            if (!pc) {
                console.warn("Answer ìˆ˜ì‹ í–ˆì§€ë§Œ pc ì—†ìŒ:", fromUser);
                return;
            }
            if (pc.signalingState !== 'have-local-offer') {
                console.warn("Answer ìˆ˜ì‹  ì‹œ signalingState ë¶ˆì¼ì¹˜:", pc.signalingState);
            }
            try {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                console.log("âœ… Answer SDP ì ìš©:", fromUser);
            } catch (e) {
                console.error("âŒ Answer ì ìš© ì‹¤íŒ¨:", e);
            }
        }

        function onVoiceCandidate(msg) {
            const pc = voiceState.peers[msg.from];
            if (!pc) return;
            pc.addIceCandidate(new RTCIceCandidate(msg.candidate)).catch(e => {
                console.warn('voiceCandidate ì¶”ê°€ ì‹¤íŒ¨:', e);
            });
        }

        function createVoicePeerConnection(remoteUser) {
            if (voiceState.peers[remoteUser]) return voiceState.peers[remoteUser];

            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });
            voiceState.peers[remoteUser] = pc;

            console.log("ğŸŒ Voice PC ìƒì„±:", remoteUser);

            // ë¡œì»¬ íŠ¸ë™ ì¶”ê°€
            if (voiceState.localStream) {
                voiceState.localStream.getAudioTracks().forEach(track => {
                    console.log(`â¡ï¸ addTrack to ${remoteUser}:`, track.label);
                    pc.addTrack(track, voiceState.localStream);
                });
            } else {
                // ì´ ê²½ê³ ëŠ” startVoiceChatì„ ìˆ˜ì •í–ˆê¸° ë•Œë¬¸ì— ê±°ì˜ ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.
                console.warn("âš ï¸ localStream ì—†ìŒ (startVoiceChat í˜¸ì¶œ ì „?)");
            }

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    safeSend({
                        type: 'voiceCandidate',
                        target: remoteUser,
                        candidate: e.candidate,
                        from: userName
                    });
                }
            };

            pc.ontrack = (e) => {
                console.log("ğŸ“¡ remote track from", remoteUser, e.streams);
                addRemoteAudio(remoteUser, e.streams[0]);
            };

            pc.onconnectionstatechange = () => {
                console.log(`ğŸ” PC(${remoteUser}) connectionState =`, pc.connectionState);
                if (['failed', 'disconnected', 'closed'].includes(pc.connectionState)) {
                    removeRemoteAudio(remoteUser);
                    try { pc.close(); } catch (_) { }
                    delete voiceState.peers[remoteUser];
                    delete voiceState.offered[remoteUser];
                }
            };

            return pc;
        }

        function addRemoteAudio(peerUser, stream) {
            let el = voiceState.remoteAudioEls[peerUser];
            if (!el) {
                el = document.createElement('audio');
                el.id = 'remote-' + peerUser;
                el.autoplay = true;
                el.playsInline = true;
                el.controls = false; // ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ¨ê¹€
                el.muted = false; // ìƒëŒ€ë°© ì†Œë¦¬ëŠ” ë“¤ë ¤ì•¼ í•¨
                el.dataset.user = peerUser;
                el.style.display = 'block';
                el.title = peerUser;
                document.getElementById('voiceRemoteContainer').appendChild(el);
                voiceState.remoteAudioEls[peerUser] = el;
            }
            el.srcObject = stream;
            el.play()
                .then(() => console.log("ğŸ”Š ì›ê²© ì¬ìƒ ì‹œì‘:", peerUser))
                .catch(err => console.warn("âš ï¸ ì›ê²© ì¬ìƒ ì‹¤íŒ¨:", peerUser, err));
        }

        // âœ¨ [ìˆ˜ì •ëœ ë¶€ë¶„] ì¤‘ë³µ ì •ì˜ ì œê±° ë° ë‹¨ì¼ í•¨ìˆ˜ ìœ ì§€
        function removeRemoteAudio(peerUser) {
            const el = voiceState.remoteAudioEls[peerUser];
            if (el) {
                el.srcObject = null;
                if (el.parentNode) el.parentNode.removeChild(el);
                delete voiceState.remoteAudioEls[peerUser];
            }
        }

        // ìŒì„± ê´€ë ¨ ë©”ì‹œì§€ ì²˜ë¦¬
        function handleVoiceMsg(msgData) {
            switch (msgData.type) {
                case 'voiceHostStart':
                    // ë°©ì¥ì´ ì‹œì‘í•˜ë©´, ì•„ì§ ì‹œì‘ ì•ˆí•œ í´ë¼ì´ì–¸íŠ¸ë“¤ì´ ìë™ìœ¼ë¡œ ì‹œì‘
                    if (!voiceState.isHost && !voiceState.isVoiceStarted) {
                        startVoiceChat();
                    }
                    break;

                // âœ¨âœ¨âœ¨ ì—¬ê¸°ê°€ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ë³€ê²½ëœ ë¶€ë¶„ì…ë‹ˆë‹¤ (Mesh êµ¬ì¡°ë¡œ ë³€ê²½) âœ¨âœ¨âœ¨
                case 'voiceReady':
                    // 'voiceReady' ì‹ í˜¸ëŠ” ìƒˆë¡œìš´ ì°¸ì—¬ìê°€ ë³´ë‚¸ "ë‚˜ ì—¬ê¸° ìˆì–´ìš”!" ë¼ëŠ” ë°©ì†¡ì…ë‹ˆë‹¤.
                    // ì´ ì‹ í˜¸ë¥¼ ë°›ì€ ê¸°ì¡´ì˜ ëª¨ë“  ì°¸ì—¬ì(ë‚˜ ìì‹  ì œì™¸)ëŠ” ê·¸ ìƒˆë¡œìš´ ì°¸ì—¬ìì—ê²Œ ì—°ê²°ì„ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.

                    // ë‚´ê°€ ë³´ë‚¸ ì‹ í˜¸ëŠ” ë¬´ì‹œ
                    if (msgData.userName === userName) break;

                    // ë‚´ê°€ ìŒì„± ì±„íŒ…ì— ì°¸ì—¬ì¤‘ì¼ ë•Œë§Œ ë°˜ì‘
                    if (voiceState.isVoiceStarted) {
                        console.log(`[MESH] ìƒˆë¡œìš´ ì°¸ì—¬ì(${msgData.userName})ê°€ ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
                        const newcomer = msgData.userName;

                        // ì´ë¯¸ Offerë¥¼ ë³´ëƒˆë‹¤ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                        if (voiceState.offered[newcomer]) {
                            console.log(`â†© ì´ë¯¸ ${newcomer}ì—ê²Œ Offerë¥¼ ë³´ëƒˆìœ¼ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.`);
                            break;
                        }

                        // PeerConnectionì„ ìƒì„±í•˜ê³  Offerë¥¼ ë³´ë‚´ëŠ” ë¡œì§ (ê¸°ì¡´ì— ë°©ì¥ë§Œ í•˜ë˜ ì¼)
                        const pc = createVoicePeerConnection(newcomer);
                        (async () => {
                            try {
                                const offer = await pc.createOffer();
                                await pc.setLocalDescription(offer);
                                voiceState.offered[newcomer] = true; // Offer ì „ì†¡ ê¸°ë¡
                                safeSend({ type: 'voiceOffer', target: newcomer, sdp: offer, from: userName });
                                console.log(`ğŸ“¨ voiceOffer ì „ì†¡ â†’ ${newcomer}`);
                            } catch (e) {
                                console.error(`âŒ ${newcomer}ì—ê²Œ Offer ìƒì„± ì‹¤íŒ¨:`, e);
                            }
                        })();
                    }
                    break;
                case 'voiceOffer': onVoiceOffer(msgData); break;
                case 'voiceAnswer': onVoiceAnswer(msgData); break;
                case 'voiceCandidate': onVoiceCandidate(msgData); break;
                case 'voiceHostStop':
                    stopVoiceChat();
                    break;
                case 'voiceMute':
                    muteRemoteAudio(msgData.userName, true);
                    break;
                case 'voiceUnmute':
                    muteRemoteAudio(msgData.userName, false);
                    break;
            }
        }

        function muteRemoteAudio(user, mute) {
            const el = voiceState.remoteAudioEls[user];
            if (el) el.muted = mute;
        }

        //íŒíŠ¸ ë¡œë”©
        function loadHintList(roomNo) {
            $.ajax({
                url: "/room/getRoomHint",
                type: "GET",
                data: { roomNo: roomNo },
                success: function (data) {
                    const container = $("#hintListContainer");
                    container.empty();
                    setHintList(data, container);
                },
                error: function () {
                    console.error("íŒíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                }
            });
        }

        //ì´ë²¤íŠ¸ ë°œìƒ
        function sendEvent(eventNo, targetNick) {
            $.ajax({
                url: '/chat/selectEvent',
                type: 'GET',
                data: {
                    eventNo: eventNo,
                    userName: targetNick //ì›ë˜ ì—¬ê¸°ì— ë§ˆí”¼ì•„ê°€ ì„ íƒí•˜ê±°ë‚˜ ëŠ¥ë ¥ ì‚¬ìš©í•˜ì—¬ ì„ íƒí•œ ë‹‰ë„¤ì„ì´ ë“¤ì–´ê°€ì•¼ í•˜ì§€ë§Œ ì„ì‹œ ì²˜ë¦¬
                },
                success: function (msg) {
                    if (msg === "") return;

                    const messageObj = {
                        type: "event",
                        userName: 'ì‹œìŠ¤í…œ',
                        msg: msg,
                        roomNo: roomNo
                    };

                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(messageObj));
                        msgInput.value = "";
                    } else {
                        alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }
                },
                error: function () {
                    alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        //ì±„íŒ… ë¡œë”©
        function chatLoad(job) {
            if (isLoading || isLastPage) return;
            isLoading = true;

            $.ajax({
                url: '/room/loadMessage',
                type: 'GET',
                data: {
                    roomNo: roomNo,
                    page: currentPage,
                    size: pageSize,
                    job: job
                },
                success: function (messages) {
                    if (messages.length === 0) {
                        isLastPage = true;  // ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë©”ì‹œì§€ ì—†ìŒ
                        return;
                    }
                    currentPage++;

                    // ë¶ˆëŸ¬ì˜¤ê¸° ì „ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œë¶€í„° ê±°ë¦¬)
                    const scrollBefore = chatArea.scrollHeight - chatArea.scrollTop;

                    messages.forEach(msgData => {
                        const div = document.createElement("div");

                        if (msgData.type && msgData.type.includes("death")) {
                            if (job !== "ghost" && job !== "mafiaGhost" && job !== "spiritualists") {
                                return;
                            } else {
                                const typeDiv = document.createElement("div");
                                typeDiv.classList.add("type-Text");
                                typeDiv.textContent = "ã€ì‚¬ë§ìã€";
                                div.appendChild(typeDiv);
                            }
                        } else if (msgData.type && msgData.type === "mafia") {
                            if (job !== "mafia") {
                                return;
                            } else {
                                const typeDiv = document.createElement("div");
                                typeDiv.classList.add("type-Text");
                                typeDiv.textContent = "ã€ë§ˆí”¼ì•„ã€";
                                div.appendChild(typeDiv);
                            }
                        }

                        reciveMsg(msgData, div);

                        // ë©”ì‹œì§€ë¥¼ ê¸°ì¡´ ì±„íŒ…ì°½ ë§¨ ìœ„ì— ì‚½ì…
                        chatArea.insertBefore(div, chatArea.firstChild);
                    });

                    // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ëª¨ë‘ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì •
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        scrollToBottomAfterImagesLoad(chatArea);
                    }

                    // ë¶ˆëŸ¬ì˜¤ê¸° í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì •: ì¶”ê°€ëœ ë©”ì‹œì§€ ë†’ì´ë§Œí¼ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
                    const scrollAfter = chatArea.scrollHeight;
                    chatArea.scrollTop = scrollAfter - scrollBefore;
                },
                complete: function () {
                    isLoading = false;
                }
            });
        }
        
		chatArea.addEventListener("scroll", function () {
			if (chatArea.scrollTop === 0 && !isLastPage && !isLoading) {
		        chatLoad();
		    }
		});

        //ì§ì—…ë™ì‘		
        function setAlive() {
            $.ajax({
                url: "/room/userDeathList",
                data: { roomNo: roomNo },
                success: function (deathList) {
                    updateUserStatus(deathList);
                },
                error: function () {
                    alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
        
        //ì§ì—…ë™ì‘
		function voteKill(targetName) {
		    $.ajax({
		        url: "/room/voteResult",
		        method: "GET",
		        data: {
		            roomNo: roomNo,
		            dayNo: dayNo,
		            targetName: targetName,
		        },
		        success: function (kill) {
		            if (!kill) return;

		            let killList = [];
		            try {
		                console.log(kill);

		                // kill.voteê°€ JSON ë¬¸ìì—´ì´ë¯€ë¡œ ì´ ë¶€ë¶„ë§Œ parse
		                if (kill.vote) {
		                    killList = JSON.parse(kill.vote);
		                }

		                const total = document.querySelectorAll(".slot").length;
		                const current = killList.length;
		                document.getElementById("killCount").innerText = "íˆ¬í‘œ: " + current + " / " + total;
		            } catch (e) {
		                console.error("íˆ¬í‘œ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨", e);
		            }
		        },
		        error: function () {
		            alert("íˆ¬í‘œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		        }
		    });
		}

        function mafiaKill(targetName) {
            $.ajax({
                url: "/room/mafiaKillResult",
                method: "GET",
                data: {
                    roomNo: roomNo,
                    dayNo: dayNo,
                    targetName: targetName,
                },
                success: function (kill) { },
                error: function () {
                    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        function doctorHeal(targetName) {
            $.ajax({
                url: "/room/healResult",
                method: "GET",
                data: {
                    roomNo: roomNo,
                    dayNo: dayNo,
                    targetName: targetName,
                },
                success: function (kill) { },
                error: function () {
                    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        function policeCheck(targetName) {
            $.ajax({
                url: "/room/policeCheck",
                method: "GET",
                data: {
                    roomNo: roomNo,
                    dayNo: dayNo,
                    targetName: targetName,
                },
                success: function (result) {
                    alert(targetName + "ì˜ ì§ì—…ì€ " + result.jobVisible + "ì…ë‹ˆë‹¤.");
                },
                error: function () {
                    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
        
        function hackHint() {
        	const msg = { type: 'HACK', userName: 'í•´ì»¤', msg: 'í•´ì»¤ê°€ snsíŒíŠ¸ë¥¼ ë°”ê¾¸ì—ˆìŠµë‹ˆë‹¤', roomNo: roomNo };
        	safeSend({ type, userName: nickName, msg, roomNo });
        }
        
		function startTimer(phase, seconds) {
			remainTime = seconds;
			if(timerId) clearInterval(timerId);
			
			hasKilld = false;
					  
			timerId = setInterval(() => {
				if(remainTime <= 0) {
					clearInterval(timerId);
					return;
				}
				remainTime--;
				updateTimerUI(phase, remainTime);
			}, 1000);
		}
		
		function spyCheck(targetName) {
            $.ajax({
                url: "/room/spyCheck",
                method: "GET",
                data: {
                    roomNo: roomNo,
                    dayNo: dayNo,
                    targetName: targetName,
                },
                success: function (result) {
                    if(result){
                    	alert("ë§ˆí”¼ì•„ì™€ ì—°ê²°ë˜ì–´ ë§ˆí”¼ì•„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                    	alert(target+"ë‹˜ì€ ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤.");
                    }
                },
                error: function () {
                    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
		
		function robberJob(targetName) {
			$.ajax({
                url: "/room/robberJob",
                method: "GET",
                data: {
                    roomNo: roomNo,
                    dayNo: dayNo,
                    targetName: targetName,
                },
                success: function (result) {
                    alert(targetName+"ë‹˜ì˜ ì§ì—…ì€ "+result+"");
                },
                error: function () {
                    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
		}
    </script>
</body>

</html>