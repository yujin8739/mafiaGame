<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/common/header.css}" />
    <link rel="stylesheet" th:href="@{/css/common/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/chat/chat.css}" />
    <link rel="stylesheet" th:href="@{/css/index.css}" />
    <link rel="stylesheet" th:href="@{/css/job/playerPanel.css}" />
    <link rel="stylesheet" th:href="@{/css/game/phoneModal.css}" />
    <link rel="stylesheet" th:href="@{/css/friend/friendList.css}" />
    <title>우주하마피아 게임룸</title>
    <style>
        #voiceRemoteContainer audio { display: block; margin: 4px 0; }
        .slot img.someNails:hover { transform: scale(1.05); filter: brightness(1.2); }
    </style>
</head>

<body>
    <div th:replace="~{common/header :: header}"></div>
    <div class="home-wrapper">
        <div class="sideAD"></div>
        <div th:replace="~{chat/gameMainChat :: gameMainChat}"></div>
        <div class="player-panel-container" style="position: relative;">
            <div id="controlPanel">
                <div th:replace="~{game/job/playerPanel :: playerPanelFragment}"></div>
                <div class="readyDiv" style="display: flex; align-items: center;">
                    <button class="startBtn" id="startBtn">Start</button>
                    <button class="readyBtn" id="readyBtn">Ready</button>
                    <div id="readyCount">Ready: 0</div>
                </div>
                <div id="gamePhaseContainer" class="game-phase">
                    <div id="dayCount">일차 : 0</div>
                    <div id="killCount">투표 : 0</div>
                    <div id="phaseDisplay">현재 단계: -</div>
                    <div id="timerDisplay">남은 시간: - 초</div>
                    <button id="startVoiceBtn">🎙 음성채팅 시작</button>
                    <button id="stopVoiceBtn" style="display:none;">🔇 음성채팅 종료</button>
                    <button id="muteVoiceBtn" style="display:none;"> 🔈 </button>
                </div>
            </div>
            <div id="voiceRemoteContainer"></div>
            <div th:replace="~{game/phoneModal :: phoneModal}"></div>
            <button id="togglePhoneModalBtn" type="button" style="margin-top: 10px;">휴대폰 열기</button>
        </div>
    </div>
    <div th:replace="~{common/footer :: footer}"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/game/voiceChat.js}"></script>

    <!-- ✨ [핵심 수정] 모든 인라인 스크립트를 제거하고, 설정 객체와 메인 모듈만 남김 -->
    <script th:inline="javascript">
        // 모듈 스크립트에서 Thymeleaf 변수를 사용할 수 있도록 window 객체에 설정
        window.MAFIA_GAME_CONFIG = {
            roomNo: /*[[${roomNo}]]*/ 0,
            nickName: /*[[${loginUser.nickName}]]*/ '익명',
            userName: /*[[${loginUser.userName}]]*/ '',
            initialRoom: /*[[${room}]]*/ null
        };
    </script>
    
    <!-- 모듈화된 메인 스크립트 로드. type="module"이 중요합니다. -->
    <script type="module" th:src="@{/js/game/main.js}"></script>
</body>
</html>