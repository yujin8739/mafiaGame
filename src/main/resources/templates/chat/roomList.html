<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ë°© ëª©ë¡</title>
    <!-- ë‹¨ì¼ CSS íŒŒì¼ë§Œ ë¡œë“œ -->
    <link rel="stylesheet" href="/css/roomList.css">
</head>
<body>

<div th:fragment="roomListFragment" style="flex: 2;">
    <div class="game-room-list-container">
        <!-- í—¤ë” -->
        <div class="room-list-header">
            <h2>ê²Œì„ë°© ëª©ë¡</h2>
        </div>

        <!-- ê²€ìƒ‰/í•„í„° ì˜ì—­ (ì˜¤ë¥¸ìª½ ì •ë ¬ë¡œ ìˆ˜ì •) -->
        <div class="filter-section">
            <div class="filter-left">
                <span class="total-rooms">ì´ <span id="totalCount">0</span>ê°œì˜ ë°©</span>
            </div>
            <div class="filter-right">
                <!-- ë°© ì¢…ë¥˜ í•„í„° -->
                <select id="typeFilter" class="filter-select">
                    <option value="ì „ì²´">ì „ì²´ ì¢…ë¥˜</option>
                    <option value="ì¼ë°˜">ì¼ë°˜</option>
                    <option value="ì¹œì„ ">ì¹œì„ </option>
                </select>
                
                <!-- ë°© ìƒíƒœ í•„í„° -->
                <select id="statusFilter" class="filter-select">
                    <option value="ì „ì²´">ì „ì²´ ìƒíƒœ</option>
                    <option value="ëŒ€ê¸°ì¤‘">ëŒ€ê¸°ì¤‘</option>
                    <option value="ê²Œì„ì¤‘">ê²Œì„ì¤‘</option>
                </select>
                
                <!-- í˜ì´ì§€ í¬ê¸° ì„ íƒ -->
                <select id="pageSizeSelect" class="filter-select">
                    <option value="5">5ê°œì”©</option>
                    <option value="10" selected>10ê°œì”©</option> 
                    <option value="15">15ê°œì”©</option>
                </select>
                
                <!-- ê²€ìƒ‰ì–´ ì…ë ¥ -->
                <input type="text" id="searchKeyword" class="search-input" placeholder="ë°© ì œëª© ê²€ìƒ‰">
                <button id="searchBtn" class="search-btn">ê²€ìƒ‰</button>
            </div>
        </div>

        <!-- ê²Œì„ë°© ëª©ë¡ í…Œì´ë¸” -->
        <div class="room-table-section">
            <!--  ë¡œë”© í‘œì‹œ -->
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <span>ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
            
            <table class="room-table">
                <thead>
                    <tr>
                        <th>ë°© ë²ˆí˜¸</th>
                        <th>ë°© ì œëª©</th>
                        <th>ì¸ì›</th>
                        <th>ë°© ì¢…ë¥˜</th>
                        <th>í˜„ì¬ìƒíƒœ</th>
                        <th>ì…ì¥</th>
                    </tr>
                </thead>
                <tbody id="roomTableBody">
                    <tr th:each="room : ${rooms}">
                        <td th:text="${room.roomNo}">1</td>
                        <td class="room-title">
                            <span th:text="${room.roomName}">ê²Œì„ë°© ì´ë¦„</span>
                            <span th:if="${room.password != null and !#strings.isEmpty(room.password)}" class="lock-icon">ğŸ”’</span>
                        </td>
                        <td class="room-count">
                            <span class="current-count" th:text="${room.currentUserCount}">0</span>/<span class="max-count" th:text="${room.headCount}">12</span>
                        </td>
                        <td>
                            <span class="room-type" th:text="${room.type}" 
                                  th:classappend="${room.type == 'ì¹œì„ ' ? ' friendly' : ' normal'}">ì¼ë°˜</span>
                        </td>
                        <td>
                            <span class="room-status waiting">ëŒ€ê¸°ì¤‘</span>
                        </td>
                        <td>
                            <button class="enter-btn"
                                    th:attr="data-roomno=${room.roomNo}, data-password=${room.password}">
                                ì…ì¥
                            </button>
                        </td>
                    </tr>
                    
                    <!-- ë¹ˆ ë°© ë©”ì‹œì§€ -->
                    <tr th:if="${rooms == null or #lists.isEmpty(rooms)}">
                        <td colspan="6" class="no-rooms">
                            <div class="empty-message">
                                <div>í˜„ì¬ ìƒì„±ëœ ê²Œì„ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!--  í˜ì´ì§• ë„¤ë¹„ê²Œì´ì…˜ (ê°€ìš´ë° ì •ë ¬) -->
        <div class="pagination-section">
            <div class="pagination-container">
                <button id="prevBtn" class="page-btn">ì´ì „</button>
                <div id="pageNumbers" class="page-numbers">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                <button id="nextBtn" class="page-btn">ë‹¤ìŒ</button>
            </div>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
    <div id="passwordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
                <span class="close" onclick="closePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>ì´ ë°©ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                <input type="password" id="roomPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <div id="passwordError" class="error-message" style="display: none;">
                    ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            </div>
            <div class="modal-buttons">
                <button class="enter-btn-bypass" onclick="confirmEnterRoom()">ì…ì¥</button>
                <button class="cancel-btn" onclick="closePasswordModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const DynamicRoomManager = {
            // ì„¤ì •ê°’
            currentPage: 1,
            currentSize: 10,
            refreshInterval: null,
            isDynamicMode: false,
            
            // ì´ˆê¸°í™”
            init() {
                // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì´ ê°œìˆ˜ í‘œì‹œ
                this.updateInitialCount();               
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                this.setupEventListeners();              
                // ì²« ë¡œë“œëŠ” ë™ì ìœ¼ë¡œ í•˜ì§€ ì•ŠìŒ
                console.log('Dynamic Room Manager ì´ˆê¸°í™” ì™„ë£Œ');
            },
            
            //  ì´ˆê¸° ë°© ê°œìˆ˜ ì„¤ì •
            updateInitialCount() {
                const existingRows = document.querySelectorAll('#roomTableBody tr');
                const totalCount = existingRows.length;
                document.getElementById('totalCount').textContent = totalCount;
            },
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners() {
                // í•„í„° ë³€ê²½ ì‹œ
                document.getElementById('typeFilter').addEventListener('change', () => {
                    this.enableDynamicMode();
                });
                
                document.getElementById('statusFilter').addEventListener('change', () => {
                    this.enableDynamicMode();
                });
                
                document.getElementById('pageSizeSelect').addEventListener('change', () => {
                    this.currentSize = parseInt(document.getElementById('pageSizeSelect').value);
                    this.loadRoomList();
                    this.enableDynamicMode();
                });
                
                // ê²€ìƒ‰ ë²„íŠ¼
                document.getElementById('searchBtn').addEventListener('click', () => {
                    this.enableDynamicMode();
                });
                
                // ê²€ìƒ‰ì–´ ì—”í„°í‚¤
                document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.enableDynamicMode();
                    }
                });
                
                // í˜ì´ì§• ë²„íŠ¼
                document.getElementById('prevBtn').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.loadRoomList();
                    }
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.currentPage++;
                    this.loadRoomList();
                });
                
                //  ê¸°ì¡´ ì…ì¥ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ì¬ì„¤ì • (ì¶©ëŒ ë°©ì§€)
                this.setupExistingEnterButtons();
            },
            
            // ë™ì  ëª¨ë“œ í™œì„±í™”
            enableDynamicMode() {
                if (!this.isDynamicMode) {
                    this.isDynamicMode = true;
                    console.log('ë™ì  ëª¨ë“œ í™œì„±í™”');
                }
                this.currentPage = 1;
                this.loadRoomList();
                this.startAutoRefresh();
            },
            
            // ê¸°ì¡´ ì…ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì • (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©)
            setupExistingEnterButtons() {
                document.querySelectorAll('.enter-btn').forEach(btn => {
                    // ê¸°ì¡´ onclick ì œê±°í•˜ê³  ìƒˆë¡œ ì„¤ì •
                    btn.removeAttribute('onclick');
                    btn.addEventListener('click', () => {
                        const roomNo = btn.dataset.roomno;
                        const password = btn.dataset.password || '';
                        enterRoom(roomNo, password);
                    });
                });
            },
            
            // ë°© ëª©ë¡ ë¡œë“œ
            loadRoomList() {
                this.showLoading();
                
                const type = document.getElementById('typeFilter').value;
                const status = document.getElementById('statusFilter').value;
                const keyword = document.getElementById('searchKeyword').value;
                
                const params = new URLSearchParams({
                    page: this.currentPage,
                    size: this.currentSize,
                    type: type,
                    status: status,
                    keyword: keyword
                });
                
                fetch(`/room/api/search?${params}`)
                    .then(response => response.json())
                    .then(data => {
                        this.hideLoading();
                        this.displayRooms(data.rooms);
                        this.updatePagination(data);
                        this.updateTotalCount(data.totalRooms);
                    })
                    .catch(error => {
                        this.hideLoading();
                        console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                        alert('ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
            },
            
            // ë°© ëª©ë¡ í‘œì‹œ
            displayRooms(rooms) {
                const tbody = document.getElementById('roomTableBody');
                tbody.innerHTML = '';
                
                if (rooms.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-rooms">
                                <div class="empty-message">
                                    <div>ì¡°ê±´ì— ë§ëŠ” ê²Œì„ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                rooms.forEach(room => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${room.roomNo}</td>
                        <td class="room-title">
                            <span>${room.roomName}</span>
                            ${room.password && room.password.trim() ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                        </td>
                        <td class="room-count">
                            <span class="current-count">${room.currentUserCount}</span>/<span class="max-count">${room.headCount}</span>
                        </td>
                        <td>
                            <span class="room-type ${this.getRoomTypeClass(room.type)}">${room.type}</span>
                        </td>
                        <td>
                            <span class="room-status ${this.getStatusClass(room.isGaming)}">${room.isGaming}</span>
                        </td>
                        <td>
                            <button class="enter-btn" onclick="enterRoom(${room.roomNo}, '${room.password || ''}')">
                                ì…ì¥
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            // í˜ì´ì§• ì—…ë°ì´íŠ¸
            updatePagination(data) {
                const { currentPage: page, totalPages } = data;
                
                document.getElementById('prevBtn').disabled = page <= 1;
                document.getElementById('nextBtn').disabled = page >= totalPages;
                
                const pageNumbers = document.getElementById('pageNumbers');
                pageNumbers.innerHTML = '';
                
                const startPage = Math.max(1, page - 2);
                const endPage = Math.min(totalPages, page + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `page-number ${i === page ? 'active' : ''}`;
                    pageBtn.onclick = () => {
                        this.currentPage = i;
                        this.loadRoomList();
                    };
                    pageNumbers.appendChild(pageBtn);
                }
            },
            
            //  ì´ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            updateTotalCount(total) {
                document.getElementById('totalCount').textContent = total;
            },
            
            //  ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
            showLoading() {
                document.getElementById('loadingSpinner').style.display = 'flex';
            },
            
            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            },
            
            //  ìë™ ìƒˆë¡œê³ ì¹¨
            startAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                this.refreshInterval = setInterval(() => {
                    if (this.isDynamicMode) {
                        this.loadRoomList();
                    }
                }, 30000);
            },
            
            //  í—¬í¼ í•¨ìˆ˜ë“¤
            getRoomTypeClass(type) {
                switch(type) {
                    case 'ì¼ë°˜': return 'normal';
                    case 'ì¹œì„ ': return 'friendly';
                    default: return 'normal';
                }
            },
            
            getStatusClass(status) {
                return status === 'ê²Œì„ì¤‘' ? 'playing' : 'waiting';
            }
        };
        
        //  í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            DynamicRoomManager.init();
        });
               
        let selectedRoomNo = null; // ê¸°ì¡´ ë³€ìˆ˜ ìœ ì§€
        
        function enterRoom(roomNo, password) {
            selectedRoomNo = roomNo;
            
            if (password && password.trim() !== '') {
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('roomPassword').focus();
            } else {
                window.location.href = '/room/' + roomNo + "/00000";
            }
        }
        
        function confirmEnterRoom() {
            const inputPassword = document.getElementById('roomPassword').value;
            
            if (!inputPassword) {
                document.getElementById('passwordError').textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
            
            window.location.href = '/room/' + selectedRoomNo + '/' + encodeURIComponent(inputPassword);
        }
        
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('roomPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            selectedRoomNo = null;
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('passwordModal');
            if (event.target === modal) {
                closePasswordModal();
            }
        }
    </script>
</div>

</body>
</html>