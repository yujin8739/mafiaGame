<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìª½ì§€ ì“°ê¸° - GodFather 0805</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/common/header.css}" />
    <link rel="stylesheet" th:href="@{/css/common/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/member/mypage.css}" />
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" th:href="@{/css/message/message.css}" />
    <link rel="stylesheet" th:href="@{/css/friend/friendList.css}" />
</head>
<body>

    <!-- ë©”ì‹œì§€ í‘œì‹œ -->
    <div th:if="${msg}">
        <script th:inline="javascript">
            alert(/*[[${msg}]]*/ 'ë©”ì‹œì§€');
        </script>
    </div>

    <!-- í—¤ë” -->
    <div th:replace="~{common/header :: header}"></div>

    <!-- ìª½ì§€ ì“°ê¸° ì»¨í…Œì´ë„ˆ -->
    <div class="message-write-container">
        <h1 class="mypage-title">
            <span th:if="${isReply}">ğŸ“ ë‹µì¥í•˜ê¸°</span>
            <span th:unless="${isReply}">ğŸ“ ìª½ì§€ ì“°ê¸°</span>
        </h1>

        <!-- ì›ë³¸ ë©”ì‹œì§€ í‘œì‹œ (ë‹µì¥ì¸ ê²½ìš°) -->
        <div th:if="${isReply and originalMessage != null}" class="original-message">
            <h4>ì›ë³¸ ë©”ì‹œì§€</h4>
            <div class="message-meta" style="margin-bottom: 10px; font-size: 12px; color: #888;">
                <strong>ë³´ë‚¸ì‚¬ëŒ:</strong> <span th:text="${originalMessage.senderNickName != null ? originalMessage.senderNickName : originalMessage.senderUserName}">ë³´ë‚¸ì‚¬ëŒ</span> |
                <strong>ë‚ ì§œ:</strong> <span th:text="${#dates.format(originalMessage.sendDate, 'yyyy-MM-dd HH:mm')}">2025-01-09 14:30</span>
            </div>
            <div class="original-content" th:text="${originalMessage.content}">
                ì›ë³¸ ë©”ì‹œì§€ ë‚´ìš©
            </div>
        </div>

        <!-- ìª½ì§€ ì‘ì„± í¼ -->
        <form class="write-form" action="/message/send" method="POST" onsubmit="return validateForm()">
            
            <div class="form-group">
                <label for="receiverUserName">ë°›ëŠ”ì‚¬ëŒ <span class="required">*</span></label>
                <input type="text" id="receiverUserName" name="receiverUserName" 
                       th:value="${receiverUserName}" 
                       placeholder="ë°›ëŠ” ì‚¬ëŒì˜ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <small class="help-text">ì •í™•í•œ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ëŒ€ì†Œë¬¸ì êµ¬ë¶„)</small>
            </div>

            <div class="form-group">
                <label for="title">ì œëª© <span class="required">*</span></label>
                <input type="text" id="title" name="title" 
                       th:value="${replyTitle}" 
                       placeholder="ìª½ì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                       maxlength="100" required>
                <div class="char-counter">
                    <span id="titleCounter">0</span>/100ì
                </div>
            </div>

            <div class="form-group">
                <label for="content">ë‚´ìš© <span class="required">*</span></label>
                <textarea id="content" name="content" 
                          placeholder="ìª½ì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì •ì¤‘í•˜ê³  ì˜ˆì˜ë°”ë¥¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”." 
                          maxlength="1000" required></textarea>
                <div class="char-counter">
                    <span id="contentCounter">0</span>/1000ì
                </div>
            </div>

            <div class="form-group">
			    <label for="messageType">ìª½ì§€ ë¶„ë¥˜</label>
			    <select id="messageType" name="messageType">
			        <option value="">ì¼ë°˜ ìª½ì§€</option>
			        <option value="ë‹µì¥">ë‹µì¥</option>
			        <option value="ì¹œêµ¬ìš”ì²­">ì¹œêµ¬ ìš”ì²­</option>
			        <option value="ê±°ë˜">ê±°ë˜</option>
			        <option value="ê²Œì„ì´ˆëŒ€">ê²Œì„ ì´ˆëŒ€</option>
			        <!-- ì‹œìŠ¤í…œì€ ê´€ë¦¬ììš©ì´ë¯€ë¡œ ì œì™¸ -->
			    </select>
            </div>

            <!-- ë‹µì¥ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ parentPrivateMsgNo í•„ë“œ ì œê±° -->
            <input th:if="${isReply and originalMessage != null}" 
                   type="hidden" name="parentPrivateMsgNo" 
                   th:value="${originalMessage.privateMsgNo}">

            <div class="form-buttons">
                <button type="submit" class="mypage-btn primary">
                    <span th:if="${isReply}">ë‹µì¥ ë³´ë‚´ê¸°</span>
                    <span th:unless="${isReply}">ìª½ì§€ ë³´ë‚´ê¸°</span>
                </button>
                <button type="button" onclick="saveDraft()" class="mypage-btn">ì„ì‹œì €ì¥</button>
                <button type="button" onclick="resetForm()" class="mypage-btn">ë‹¤ì‹œì“°ê¸°</button>
                <a href="javascript:history.back()" class="mypage-btn">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>

    <!-- í‘¸í„° -->
    <div th:replace="~{common/footer :: footer}"></div>

    <script th:inline="javascript">
        $(document).ready(function() {
            // ê¸€ì ìˆ˜ ì¹´ìš´í„°
            updateCharCounter();
            
            $('#title').on('input', updateCharCounter);
            $('#content').on('input', updateCharCounter);

            // ì„ì‹œì €ì¥ëœ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°
            loadDraft();
            
            console.log('ìª½ì§€ ì“°ê¸° í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        });

        // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
        function updateCharCounter() {
            const titleLength = $('#title').val().length;
            const contentLength = $('#content').val().length;
            
            $('#titleCounter').text(titleLength);
            $('#contentCounter').text(contentLength);
            
            // ê¸€ì ìˆ˜ ì œí•œ ê²½ê³ 
            if (titleLength > 90) {
                $('#titleCounter').css('color', '#ff3b3b');
            } else {
                $('#titleCounter').css('color', '#888');
            }
            
            if (contentLength > 900) {
                $('#contentCounter').css('color', '#ff3b3b');
            } else {
                $('#contentCounter').css('color', '#888');
            }
        }

        // í¼ ìœ íš¨ì„± ê²€ì‚¬
        function validateForm() {
            const receiverUserName = $('#receiverUserName').val().trim();
            const title = $('#title').val().trim();
            const content = $('#content').val().trim();
            
            if (!receiverUserName) {
                alert('ë°›ëŠ” ì‚¬ëŒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#receiverUserName').focus();
                return false;
            }
            
            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#title').focus();
                return false;
            }
            
            if (!content) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                $('#content').focus();
                return false;
            }
            
            if (title.length > 100) {
                alert('ì œëª©ì€ 100ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                $('#title').focus();
                return false;
            }
            
            if (content.length > 1000) {
                alert('ë‚´ìš©ì€ 1000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                $('#content').focus();
                return false;
            }

            // ìê¸° ìì‹ ì—ê²Œ ë³´ë‚´ëŠ”ì§€ í™•ì¸
            const currentUser = /*[[${senderUserName}]]*/ '';
            if (receiverUserName === currentUser) {
                alert('ìê¸° ìì‹ ì—ê²ŒëŠ” ìª½ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                $('#receiverUserName').focus();
                return false;
            }
            
            return confirm('ìª½ì§€ë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?');
        }

        // ì„ì‹œì €ì¥
        function saveDraft() {
            const draftData = {
                receiverUserName: $('#receiverUserName').val(),
                title: $('#title').val(),
                content: $('#content').val(),
                messageType: $('#messageType').val(),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('messageDraft', JSON.stringify(draftData));
            alert('ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDraft() {
            const draft = localStorage.getItem('messageDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    
                    // 24ì‹œê°„ì´ ì§€ë‚œ ì„ì‹œì €ì¥ì€ ì‚­ì œ
                    const draftTime = new Date(draftData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - draftTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        localStorage.removeItem('messageDraft');
                        return;
                    }
                    
                    // í˜„ì¬ í¼ì´ ë¹„ì–´ìˆê³  ë‹µì¥ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë¶ˆëŸ¬ì˜¤ê¸°
                    const isReply = /*[[${isReply}]]*/ false;
                    if (!isReply && !$('#receiverUserName').val() && !$('#title').val() && !$('#content').val()) {
                        if (confirm('ì„ì‹œì €ì¥ëœ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            $('#receiverUserName').val(draftData.receiverUserName || '');
                            $('#title').val(draftData.title || '');
                            $('#content').val(draftData.content || '');
                            $('#messageType').val(draftData.messageType || '');
                            updateCharCounter();
                        }
                    }
                } catch (e) {
                    console.error('ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                    localStorage.removeItem('messageDraft');
                }
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const isReply = /*[[${isReply}]]*/ false;
                if (!isReply) {
                    $('#receiverUserName').val('');
                    $('#title').val('');
                }
                $('#content').val('');
                $('#messageType').val('');
                updateCharCounter();
                
                // ì„ì‹œì €ì¥ ì‚­ì œ
                localStorage.removeItem('messageDraft');
            }
        }

        // í˜ì´ì§€ ë– ë‚  ë•Œ ì„ì‹œì €ì¥ í™•ì¸
        window.addEventListener('beforeunload', function(e) {
            const hasContent = $('#content').val().trim() || $('#title').val().trim();
            if (hasContent) {
                saveDraft();
            }
        });
    </script>

</body>
</html>