<div th:fragment="header">
    <div th:if="${msg}">
        <script th:inline="javascript">
            alert(/*[[${msg}]]*/ 'íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        </script>
    </div>

    <!-- í—¤ë” ì˜ì—­ -->
    <div class="header">
        <div class="nav-links"></div>

        <!-- ë¡œê³  -->
        <div class="logo">
            <a href="/"> 
                <img src="/images/godFatherLogo.png" alt="GodFather ë¡œê³ ">
            </a>
        </div>


        <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
        <div th:if="${loginUser == null}">
            <div class="auth-buttons">
                <a href="/login/view">ë¡œê·¸ì¸</a>
                <a href="/login/register">íšŒì›ê°€ì…</a>
            </div>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
        <div th:if="${loginUser != null}">
            <div class="auth-buttons" style="flex-direction: column; align-items: center;">

                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜ì—­ -->
                <div class="profile-wrapper">
                    <a href="/mypage/myitems">
                        <!-- âœ… í…Œë‘ë¦¬ ì´ë¯¸ì§€ -->
                        <img src="/images/profile/iron.png"
                             class="border-img"
                             th:style="${session.borderEnabled == 'Y'} ? 'display:block' : 'display:none'"
                             alt="í…Œë‘ë¦¬ ì´ë¯¸ì§€">

                        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                        <img class="profile-img"
                             th:src="${loginUser.profileImage != null} ? ${loginUser.profileImage} : '/images/profile/Profile.png'"
                             alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
                    </a>
                </div>

                <!-- ë‹‰ë„¤ì„ ë° ë§ˆì´í˜ì´ì§€/ë¡œê·¸ì•„ì›ƒ/ì„¤ì • -->
                <div class="text-and-buttons">
                    <span th:text="${loginUser.nickName} + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!'"></span>
                    <div class="links" style="display: flex; align-items: center; gap: 5px;">
                        <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
                        <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
                        <!-- âš™ ì„¤ì • ì•„ì´ì½˜ -->
                        <button id="open-settings" style="background: none; border: none;" title="ì„¤ì • ì—´ê¸°">
                            <img src="/images/profile/gear.png" style="width: 20px;" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



	<!--  ëª¨ë‹¬ì°½: í…Œë‘ë¦¬ ì„¤ì • -->
	<div id="settings-modal">
	    <div class="modal-content">
	        <h3>âš™ ì„¤ì •</h3>

	        <label>
	            <input type="checkbox" id="modal-toggle-border"
	                   th:checked="${session.borderEnabled == 'Y'}"> í…Œë‘ë¦¬ ë³´ê¸°
	        </label>

	        <div>
	            <button type="button" id="resetProfileBtn">ê¸°ë³¸ í”„ë¡œí•„ë¡œ ì„¤ì •</button>
	        </div>

	        <div style="margin-top: 15px;">
	            <button id="save-settings">ì €ì¥</button>
	            <button id="close-settings">ë‹«ê¸°</button>
	        </div>
	    </div>
	</div>

    <!--  ëª¨ë‹¬ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const openBtn = document.getElementById("open-settings");
        const closeBtn = document.getElementById("close-settings");
        const saveBtn = document.getElementById("save-settings");
        const modal = document.getElementById("settings-modal");
        const modalCheckbox = document.getElementById("modal-toggle-border");
        const borderImg = document.querySelector(".border-img");

        if (!openBtn || !closeBtn || !saveBtn || !modal || !modalCheckbox) return;

        openBtn.addEventListener("click", () => {
            modal.style.display = "flex";
        });

        closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        saveBtn.addEventListener("click", () => {
            const isEnabled = modalCheckbox.checked ? 'Y' : 'N';

            fetch('/profile/setBorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'borderEnabled=' + encodeURIComponent(isEnabled)
            }).then(res => {
                if (!res.ok) {
                    alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨");
                }
            });

            // ì¦‰ì‹œ ì ìš©
            if (borderImg) {
                borderImg.style.display = (isEnabled === 'Y') ? 'block' : 'none';
            }

            modal.style.display = "none";
        });
    });
    </script>



<div class="top-nav">
  <ul class="menu">
	


    <!-- ê²Œì„ -->
    <li class="menu-item">
      <a href="/">ê²Œì„ì°¾ê¸°</a>
    </li>

    <!-- ë¼ìš´ì§€ -->
    <li class="menu-item">
      <a th:href="@{/board/lounge}">ë¼ìš´ì§€</a>
    </li>

    <!-- ì»¤ë®¤ë‹ˆí‹° (í´ë¦­ ë¶ˆê°€) -->
    <li class="menu-item">
      <span class="disabled-link">ì»¤ë®¤ë‹ˆí‹°</span>
    </li>

    <!-- ìƒì  (í´ë¦­ ë¶ˆê°€) -->
    <li class="menu-item">
      <span class="disabled-link">ìƒì </span>
    </li>

  </ul>

  <!-- ì „ì²´ í•˜ìœ„ ë©”ë‰´ ë“œë¡­ë‹¤ìš´ -->
  <div class="all-submenus">
    <div class="menu-group">
      <!-- ê²Œì„ í•˜ìœ„ ë©”ë‰´ -->
      <div class="menu-column">
        <a th:href="@{/room/createRoom}">ê²Œì„ ìƒì„±</a>
        <a href="/">ë­í¬ê²Œì„</a>
      </div>
      <!-- ë¼ìš´ì§€ í•˜ìœ„ ë©”ë‰´ -->
      <div class="menu-column">
        <a th:href="@{/board/gallery}">ê°¤ëŸ¬ë¦¬</a>
        <a th:href="@{/board/video}">í•˜ì´ë¼ì´íŠ¸ ì˜ìƒ</a>
        <a th:href="@{/introduce/list}">ê²Œì„ì†Œê°œ</a>
      </div>
      <!-- ì»¤ë®¤ë‹ˆí‹° í•˜ìœ„ ë©”ë‰´ -->
      <div class="menu-column">
        <a href="javascript:void(0)" onclick="openFriendSidebar()">ì¹œêµ¬ëª©ë¡</a>
        <a th:href="@{/message/inbox}">ìª½ì§€í•¨</a>
        <a th:href="@{/notice/list}">ê³µì§€ì‚¬í•­</a>
      </div>
      <!-- ìƒì  í•˜ìœ„ ë©”ë‰´ -->
      <div class="menu-column">
        <a th:href="@{/artshop}">ì•„íŠ¸ìƒµ</a>
        <a th:href="@{/itemshop}">ì•„ì´í…œìƒì </a>
      </div>
    </div>
  </div>
  
  <div style="position: fixed; top: 10px; left: 10px; z-index: 9999; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;">
      <audio id="bgm-audio" src="/music/test1.mp3" th:src="@{/music/test1.mp3}" loop></audio>
      <button id="play-btn">â–¶ï¸ ì¬ìƒ</button>
      <button id="pause-btn">â¸ï¸ ì •ì§€</button>
  </div>

  <script>
    window.onload = () => {
      const audio = document.getElementById('bgm-audio');
      const playBtn = document.getElementById('play-btn');
      const pauseBtn = document.getElementById('pause-btn');

      const bgmState = localStorage.getItem('bgmState');
      const savedTime = parseFloat(localStorage.getItem('bgmTime')) || 0;

      // ì €ì¥ëœ ì¬ìƒ ìœ„ì¹˜ ë³µì›
      audio.currentTime = savedTime;

      if (bgmState === 'playing') {
        audio.play().catch(() => {
          console.log("ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì§ì ‘ ì¬ìƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        });
      }

      playBtn.onclick = () => {
        audio.play();
        localStorage.setItem('bgmState', 'playing');
      };

      pauseBtn.onclick = () => {
        audio.pause();
        localStorage.setItem('bgmState', 'paused');
      };

      // ì¬ìƒ ì¤‘ì¼ ë•Œ ì¬ìƒ ìœ„ì¹˜ ì €ì¥ (0.5ì´ˆë§ˆë‹¤)
      setInterval(() => {
        if (!audio.paused) {
          localStorage.setItem('bgmTime', audio.currentTime);
        }
      }, 500);
    };

    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œë„ ì¬ìƒ ìœ„ì¹˜ ì €ì¥
    window.onbeforeunload = () => {
      const audio = document.getElementById('bgm-audio');
      localStorage.setItem('bgmTime', audio.currentTime);
    };
  </script>
</div>

<script>
document.getElementById("resetProfileBtn").addEventListener("click", function () {
    if (confirm("ê¸°ë³¸ í”„ë¡œí•„ë¡œ ë³€ê²½í• ê¹Œìš”?")) {
        fetch("/mypage/reset-profile", {
            method: "POST"
        }).then(response => {
            if (response.ok) {
                alert("ê¸°ë³¸ í”„ë¡œí•„ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜
            } else {
                alert("ë³€ê²½ ì‹¤íŒ¨");
            }
        });
    }
});
</script>

<div th:replace="~{friend/friendSidebar :: friendSidebarFragment}"></div>

<script>
    // ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜
    function openFriendSidebar() {
        $('#sidebarOverlay').addClass('active');
        $('#friendSidebar').addClass('active');
        $('body').css('overflow', 'hidden');
        loadFriendData();
    }

    function closeFriendSidebar() {
        $('#sidebarOverlay').removeClass('active');
        $('#friendSidebar').removeClass('active');
        $('body').css('overflow', 'auto');
        hideSearchResult();
    }

    function switchTab(tabName) {
        $('.tab-btn').removeClass('active');
        $(`[data-tab="${tabName}"]`).addClass('active');
        
        $('.tab-content').removeClass('active');
        $(`#${tabName}Tab`).addClass('active');
    }

    function hideSearchResult() {
        $('#searchResult').removeClass('show');
    }

    // ì¹œêµ¬ ê²€ìƒ‰
    function searchFriend() {
        const searchKeyword = $('#friendSearchInput').val().trim();
        
        if (!searchKeyword) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        $.ajax({
            url: '/friend/search',
            type: 'POST',
            data: { searchKeyword: searchKeyword },
            success: function(response) {
                if (response.success) {
                    showSearchResult(response.user);
                } else {
                    alert(response.message);
                    hideSearchResult();
                }
            },
            error: function() {
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function showSearchResult(user) {
        $('#searchedUserName').text(user.userName);
        $('#searchedUserNickname').text(user.nickName);
        $('#searchResult').addClass('show');
    }

    // ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°
    function sendFriendRequest() {
        const targetUser = $('#searchedUserName').text();
        
        $.ajax({
            url: '/friend/request',
            type: 'POST',
            data: { targetUserName: targetUser },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    hideSearchResult();
                    $('#friendSearchInput').val('');
                }
            },
            error: function() {
                alert('ì¹œêµ¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì¹œêµ¬ ë°ì´í„°ë¥¼ Ajaxë¡œ ì‹¤ì‹œê°„ ë¡œë“œ
    function loadFriendData() {
        $.ajax({
            url: '/friend/notifications',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    updateFriendList(response.friendList || []);
                    updateRequestList(response.friendRequests || []);
                    updateInviteList(response.gameInvites || []);
                }
            },
            error: function() {
                console.log('ì¹œêµ¬ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì¹œêµ¬ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateFriendList(friendList) {
        $('#friendList').empty();
        $('#friendCount').text(friendList.length);
        
        if (friendList.length === 0) {
            $('#friendsEmpty').show();
            return;
        }
        
        $('#friendsEmpty').hide();
        friendList.forEach(function(friend) {
            const friendItem = createFriendItem(friend);
            $('#friendList').append(friendItem);
        });
    }

    // ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateRequestList(friendRequests) {
        $('#requestList').empty();
        $('#requestCount').text(friendRequests.length);
        
        if (friendRequests.length === 0) {
            $('#requestsEmpty').show();
            return;
        }
        
        $('#requestsEmpty').hide();
        friendRequests.forEach(function(request) {
            const requestItem = createRequestItem(request);
            $('#requestList').append(requestItem);
        });
    }

    // ê²Œì„ ì´ˆëŒ€ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateInviteList(gameInvites) {
        $('#inviteList').empty();
        $('#inviteCount').text(gameInvites.length);
        
        if (gameInvites.length === 0) {
            $('#invitesEmpty').show();
            return;
        }
        
        $('#invitesEmpty').hide();
        gameInvites.forEach(function(invite) {
            const inviteItem = createInviteItem(invite);
            $('#inviteList').append(inviteItem);
        });
    }

    // ì¹œêµ¬ ì•„ì´í…œ ìƒì„±
    function createFriendItem(friend) {
        return $(`
            <li class="friend-item">
                <div class="friend-avatar">
                    ğŸ‘¤
                    <div class="online-status offline"></div>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.friendNickName || friend.friendUserName}</div>
                    <div class="friend-status">ì˜¤í”„ë¼ì¸</div>
                </div>
                <div class="friend-actions">
                    <button class="action-btn message-btn" onclick="sendMessage('${friend.friendUserName}')">ìª½ì§€</button>
                    <button class="action-btn invite-btn" onclick="inviteToGame('${friend.friendUserName}')">ì´ˆëŒ€</button>
                    <button class="action-btn remove-btn" onclick="removeFriend('${friend.friendUserName}')">ì‚­ì œ</button>
                </div>
            </li>
        `);
    }

    // ì¹œêµ¬ ìš”ì²­ ì•„ì´í…œ ìƒì„±
    function createRequestItem(request) {
        return $(`
            <li class="friend-item">
                <div class="friend-avatar">ğŸ‘¤</div>
                <div class="friend-info">
                    <div class="friend-name">${request.requesterNickName || request.requesterName}</div>
                    <div class="friend-status">ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤</div>
                </div>
                <div class="friend-actions">
                    <button class="action-btn accept-btn" onclick="acceptFriendRequest(${request.relationNo})">ìˆ˜ë½</button>
                    <button class="action-btn reject-btn" onclick="rejectFriendRequest(${request.relationNo})">ê±°ì ˆ</button>
                </div>
            </li>
        `);
    }

    // ê²Œì„ ì´ˆëŒ€ ì•„ì´í…œ ìƒì„±
    function createInviteItem(invite) {
        return $(`
            <li class="friend-item">
                <div class="friend-avatar">ğŸ®</div>
                <div class="friend-info">
                    <div class="friend-name">${invite.senderNickName || invite.senderName}</div>
                    <div class="friend-status">${invite.roomName}ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤</div>
                </div>
                <div class="friend-actions">
                    <button class="action-btn accept-btn" onclick="acceptGameInvite(${invite.inviteNo})">ìˆ˜ë½</button>
                    <button class="action-btn reject-btn" onclick="rejectGameInvite(${invite.inviteNo})">ê±°ì ˆ</button>
                </div>
            </li>
        `);
    }

    // ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½
    function acceptFriendRequest(relationNo) {
        $.ajax({
            url: '/friend/accept',
            type: 'POST',
            data: { relationNo: relationNo },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    loadFriendData();
                }
            },
            error: function() {
                alert('ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ
    function rejectFriendRequest(relationNo) {
        $.ajax({
            url: '/friend/reject',
            type: 'POST',
            data: { relationNo: relationNo },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    loadFriendData();
                }
            },
            error: function() {
                alert('ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì¹œêµ¬ ì‚­ì œ
    function removeFriend(friendUserName) {
        if (!confirm('ì •ë§ë¡œ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
        
        $.ajax({
            url: '/friend/delete',
            type: 'POST',
            data: { friendUserName: friendUserName },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    loadFriendData();
                }
            },
            error: function() {
                alert('ì¹œêµ¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ê²Œì„ ì´ˆëŒ€ ìˆ˜ë½
    function acceptGameInvite(inviteNo) {
        $.ajax({
            url: '/friend/invite/respond',
            type: 'POST',
            data: { 
                inviteNo: inviteNo,
                status: 'ACCEPTED'
            },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    loadFriendData();
                    // ê²Œì„ë°©ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                }
            },
            error: function() {
                alert('ê²Œì„ ì´ˆëŒ€ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ê²Œì„ ì´ˆëŒ€ ê±°ì ˆ
    function rejectGameInvite(inviteNo) {
        $.ajax({
            url: '/friend/invite/respond',
            type: 'POST',
            data: { 
                inviteNo: inviteNo,
                status: 'REJECTED'
            },
            success: function(response) {
                alert(response.message);
                if (response.success) {
                    loadFriendData();
                }
            },
            error: function() {
                alert('ê²Œì„ ì´ˆëŒ€ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ìª½ì§€ ë³´ë‚´ê¸° (ë¯¸êµ¬í˜„)
    function sendMessage(userName) {
        window.location.href = '/message/write';
    }

    // ê²Œì„ ì´ˆëŒ€í•˜ê¸°
    function inviteToGame(userName) {
        alert('í˜„ì¬ ê¸°ëŠ¥ êµ¬í˜„ì¤‘ ì«Œë§Œ ê¸°ë‹¤ë¦¬ì‚¼.');
    }

    // ë¬¸ì„œ ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $(document).ready(function() {
        // ì‚¬ì´ë“œë°” ë‹«ê¸° ì´ë²¤íŠ¸
        $(document).on('click', '#closeSidebarBtn, #sidebarOverlay', function() {
            closeFriendSidebar();
        });

        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        $(document).on('click', '.tab-btn', function() {
            const tabName = $(this).data('tab');
            switchTab(tabName);
        });

        // ESC í‚¤ë¡œ ì‚¬ì´ë“œë°” ë‹«ê¸°
        $(document).on('keydown', function(e) {
            if (e.which === 27) { // ESC key
                closeFriendSidebar();
            }
        });

        // ì¹œêµ¬ ê²€ìƒ‰ ì´ë²¤íŠ¸
        $(document).on('click', '#searchFriendBtn', searchFriend);
        $(document).on('keypress', '#friendSearchInput', function(e) {
            if (e.which === 13) { // Enter key
                searchFriend();
            }
        });

        // ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸° ì´ë²¤íŠ¸
        $(document).on('click', '#sendRequestBtn', sendFriendRequest);
    });
</script>
</div>