<div th:fragment="header">
    <div th:if="${msg}">
        <script th:inline="javascript">
            alert(/*[[${msg}]]*/ '회원 정보가 수정되었습니다.');
        </script>
    </div>

    <!-- 헤더 영역 -->
    <div class="header">
        <div class="nav-links"></div>

        <!-- 로고 -->
        <div class="logo">
            <a href="/"> 
                <img src="/godDaddy_etc/homeImages/godFatherLogo.png" alt="GodFather 로고">
            </a>
        </div>

        <!-- 비로그인 상태 -->
        <div th:if="${loginUser == null}">
            <div class="auth-buttons">
                <a href="/login/view">로그인</a>
                <a href="/login/register">회원가입</a>
            </div>
        </div>

        <!-- 로그인 상태 -->
        <div th:if="${loginUser != null}">
            <div class="auth-buttons" style="flex-direction: column; align-items: center;">
                <!-- 프로필 이미지 영역 -->
                <div class="profile-wrapper">
                    <a href="/mypage/myitems">
                        <!--
                        <img src="/images/profile/iron.png"
                             class="border-img"
                             th:style="${session.borderEnabled == 'Y'} ? 'display:block' : 'display:none'"
                             alt="테두리 이미지">
                        -->
                        <img class="profile-img"
                             th:src="${loginUser.profileImage != null} ? ${loginUser.profileImage} : '/godDaddy_etc/profile/Profile.png'"
                             alt="프로필 이미지" />
                    </a>
                </div>

                <!-- 닉네임 및 마이페이지/로그아웃/설정 -->
                <div class="text-and-buttons">
                    <span th:text="${loginUser.nickName} + '님 환영합니다!'"></span>
                    <div class="links" style="display: flex; align-items: center; gap: 5px;">
                        <a href="/mypage">마이페이지</a>
                        <a href="/logout">로그아웃</a>
                        <!-- ⚙ 설정 아이콘 -->
                        <button id="open-settings" style="background: none; border: none;" title="설정 열기">
                            <img src="/godDaddy_etc/profile/gear.png" style="width: 20px;" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  모달창: 테두리 설정 -->
    <div id="settings-modal">
        <div class="modal-content" id="modal-toggle-border">
            <h3>⚙ 설정</h3>

            <div>
                <button type="button" id="resetProfileBtn">기본 프로필로 설정</button>
            </div>

            <div style="margin-top: 15px;">
                <button id="save-settings">저장</button>
                <button id="close-settings">닫기</button>
            </div>
        </div>
    </div>

    <!--  모달 설정 스크립트 -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const openBtn = document.getElementById("open-settings");
        const closeBtn = document.getElementById("close-settings");
        const saveBtn = document.getElementById("save-settings");
        const modal = document.getElementById("settings-modal");
        const modalCheckbox = document.getElementById("modal-toggle-border");
        const borderImg = document.querySelector(".border-img");

        if (!openBtn || !closeBtn || !saveBtn || !modal || !modalCheckbox) return;

        openBtn.addEventListener("click", () => {
            modal.style.display = "flex";
        });

        closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        saveBtn.addEventListener("click", () => {
            // borderEnabled 값을 체크박스 대신 div(id=modal-toggle-border)로 감싸서 체크 여부 판단 시 수정 필요!
            // 만약 체크박스가 없다면 여기 코드를 다시 점검해야 합니다.
            // 아래는 기존 로직 유지 (참고용)
            const isEnabled = modalCheckbox.checked ? 'Y' : 'N';

            fetch('/profile/setBorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'borderEnabled=' + encodeURIComponent(isEnabled)
            }).then(res => {
                if (!res.ok) {
                    alert("설정 저장 실패");
                }
            });

            if (borderImg) {
                borderImg.style.display = (isEnabled === 'Y') ? 'block' : 'none';
            }

            modal.style.display = "none";
        });
    });
    </script>

    <div style="position: fixed; top: 10px; left: 10px; z-index: 9999; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;">
        <audio id="bgm-audio" src="/music/test1.mp3" th:src="@{/music/test1.mp3}" loop></audio>
        <button id="play-btn">▶️ 재생</button>
        <button id="pause-btn">⏸️ 정지</button>
    </div>

    <script>
        window.onload = () => {
            const audio = document.getElementById('bgm-audio');
            const playBtn = document.getElementById('play-btn');
            const pauseBtn = document.getElementById('pause-btn');

            const bgmState = localStorage.getItem('bgmState');
            const savedTime = parseFloat(localStorage.getItem('bgmTime')) || 0;

            audio.currentTime = savedTime;

            if (bgmState === 'playing') {
                audio.play().catch(() => {
                    console.log("자동 재생이 차단되었습니다. 사용자가 직접 재생해야 합니다.");
                });
            }

            playBtn.onclick = () => {
                audio.play();
                localStorage.setItem('bgmState', 'playing');
            };

            pauseBtn.onclick = () => {
                audio.pause();
                localStorage.setItem('bgmState', 'paused');
            };

            setInterval(() => {
                if (!audio.paused) {
                    localStorage.setItem('bgmTime', audio.currentTime);
                }
            }, 500);
        };

        window.onbeforeunload = () => {
            const audio = document.getElementById('bgm-audio');
            localStorage.setItem('bgmTime', audio.currentTime);
        };
    </script>

    <script>
    document.getElementById("resetProfileBtn").addEventListener("click", function () {
        if (confirm("기본 프로필로 변경할까요?")) {
            fetch("/mypage/reset-profile", {
                method: "POST"
            }).then(response => {
                if (response.ok) {
                    alert("기본 프로필로 변경되었습니다.");
                    location.reload(); // 새로고침으로 즉시 반영
                } else {
                    alert("변경 실패");
                }
            });
        }
    });
    </script>

    <!-- 친구 사이드바 fragment 불러오기 -->
    <div th:replace="~{friend/friendSidebar :: friendSidebarFragment}"></div>

    <!-- 친구 관련 JS 외부 분리된 스크립트 로드 -->
    <script src="/js/friend/friendsidebar.js"></script>

    <div class="top-nav">
      <ul class="menu">
        <li class="menu-item">
          <a href="/">게임찾기</a>
        </li>
        <li class="menu-item">
          <a th:href="@{/board/lounge}">라운지</a>
        </li>
        <li class="menu-item">
          <span class="disabled-link">커뮤니티</span>
        </li>
        <li class="menu-item">
          <span class="disabled-link">상점</span>
        </li>
      </ul>

      <div class="all-submenus">
        <div class="menu-group">
          <div class="menu-column">
            <a th:href="@{/room/createRoom}">게임 생성</a>
            <a href="/">랭크게임</a>
          </div>
          <div class="menu-column">
            <a th:href="@{/board/gallery}">갤러리</a>
            <a th:href="@{/board/video}">하이라이트 영상</a>
            <a th:href="@{/introduce/list}">게임소개</a>
          </div>
          <div class="menu-column">
            <a href="javascript:void(0)" onclick="openFriendSidebar()">친구목록</a>
            <a th:href="@{/message/inbox}">쪽지함</a>
            <a th:href="@{/notice/list}">공지사항</a>
          </div>
          <div class="menu-column">
            <a th:href="@{/artshop}">아트샵</a>
            <a th:href="@{/itemshop}">아이템상점</a>
          </div>
        </div>
      </div>
    </div>
</div>
