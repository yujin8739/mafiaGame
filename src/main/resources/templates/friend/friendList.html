<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹œêµ¬ëª©ë¡ - GodFather 0805</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/common/header.css}" />
    <link rel="stylesheet" th:href="@{/css/common/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/member/mypage.css}" />
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" th:href="@{/css/friend/friendList.css}" />
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ì¹œêµ¬ ì‚¬ì´ë“œë°” -->
    <div class="friend-sidebar" id="friendSidebar">
        <!-- ì‚¬ì´ë“œë°” í—¤ë” -->
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ‘¥ ì¹œêµ¬ ëª©ë¡</div>
            <button class="close-btn" id="closeSidebarBtn">&times;</button>
        </div>

        <!-- ì¹œêµ¬ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="friend-search-section">
            <div class="search-container">
                <input type="text" class="search-input" id="friendSearchInput" placeholder="ì¹œêµ¬ ê²€ìƒ‰ (ì•„ì´ë”” ë˜ëŠ” ë‹‰ë„¤ì„)">
                <button class="search-btn" id="searchFriendBtn">ê²€ìƒ‰</button>
            </div>
            
            <!-- ê²€ìƒ‰ ê²°ê³¼ -->
            <div class="search-result" id="searchResult">
                <div class="search-user">
                    <div class="user-info">
                        <div class="user-name" id="searchedUserName"></div>
                        <div class="user-nickname" id="searchedUserNickname"></div>
                    </div>
                    <button class="action-btn friend-request-btn" id="sendRequestBtn">ì¹œêµ¬ ìš”ì²­</button>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="sidebar-tabs">
            <button class="tab-btn active" data-tab="friends">
                ì¹œêµ¬ ëª©ë¡ <span class="notification-badge" id="friendCount">0</span>
            </button>
            <button class="tab-btn" data-tab="requests">
                ìš”ì²­ <span class="notification-badge" id="requestCount">0</span>
            </button>
            <button class="tab-btn" data-tab="invites">
                ê²Œì„ ì´ˆëŒ€ <span class="notification-badge" id="inviteCount">0</span>
            </button>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="sidebar-content">
            <!-- ì¹œêµ¬ ëª©ë¡ íƒ­ -->
            <div class="tab-content active" id="friendsTab">
                <ul class="friend-list" id="friendList">
                    <!-- ì¹œêµ¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
                <div class="empty-state" id="friendsEmpty" style="display: none;">
                    <div class="empty-icon">ğŸ‘¥</div>
                    <div>ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    <div>ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</div>
                </div>
            </div>

            <!-- ì¹œêµ¬ ìš”ì²­ íƒ­ -->
            <div class="tab-content" id="requestsTab">
                <ul class="friend-list" id="requestList">
                    <!-- ì¹œêµ¬ ìš”ì²­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
                <div class="empty-state" id="requestsEmpty" style="display: none;">
                    <div class="empty-icon">ğŸ“¬</div>
                    <div>ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- ê²Œì„ ì´ˆëŒ€ íƒ­ -->
            <div class="tab-content" id="invitesTab">
                <ul class="friend-list" id="inviteList">
                    <!-- ê²Œì„ ì´ˆëŒ€ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
                <div class="empty-state" id="invitesEmpty" style="display: none;">
                    <div class="empty-icon">ğŸ®</div>
                    <div>ë°›ì€ ê²Œì„ ì´ˆëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

 <script th:inline="javascript">
   $(document).ready(function() {
       // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ì´ë“œë°” ì—´ê¸°
       openFriendSidebar();
       
       // ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸° ì´ë²¤íŠ¸
       $('#closeSidebarBtn, #sidebarOverlay').on('click', function() {
           closeFriendSidebar();
       });

       // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
       $('.tab-btn').on('click', function() {
           const tabName = $(this).data('tab');
           switchTab(tabName);
       });

       // ì¹œêµ¬ ê²€ìƒ‰ ì´ë²¤íŠ¸
       $('#searchFriendBtn').on('click', searchFriend);
       $('#friendSearchInput').on('keypress', function(e) {
           if (e.which === 13) { // Enter key
               searchFriend();
           }
       });

       // ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸° ì´ë²¤íŠ¸
       $('#sendRequestBtn').on('click', sendFriendRequest);

       // ESC í‚¤ë¡œ ì‚¬ì´ë“œë°” ë‹«ê¸°
       $(document).on('keydown', function(e) {
           if (e.which === 27) { // ESC key
               closeFriendSidebar();
           }
       });

       // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
       loadFriendData();
   });

   // ì‚¬ì´ë“œë°” ì—´ê¸° í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ í—¤ë”ì—ì„œ í˜¸ì¶œ)
   function openFriendSidebar() {
       $('#sidebarOverlay').addClass('active');
       $('#friendSidebar').addClass('active');
       $('body').css('overflow', 'hidden');
       loadFriendData(); // ì‚¬ì´ë“œë°” ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ë°ì´í„° ë¡œë“œ
   }

   // ì‚¬ì´ë“œë°” ë‹«ê¸°
   function closeFriendSidebar() {
       $('#sidebarOverlay').removeClass('active');
       $('#friendSidebar').removeClass('active');
       $('body').css('overflow', 'auto');
       hideSearchResult();
   }

   // íƒ­ ì „í™˜
   function switchTab(tabName) {
       $('.tab-btn').removeClass('active');
       $(`[data-tab="${tabName}"]`).addClass('active');
       
       $('.tab-content').removeClass('active');
       $(`#${tabName}Tab`).addClass('active');
   }

   // ì¹œêµ¬ ê²€ìƒ‰
   function searchFriend() {
       const searchKeyword = $('#friendSearchInput').val().trim();
       
       if (!searchKeyword) {
           alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
           return;
       }
       
       $.ajax({
           url: '/friend/search',
           type: 'POST',
           data: { searchKeyword: searchKeyword },
           success: function(response) {
               if (response.success) {
                   showSearchResult(response.user);
               } else {
                   alert(response.message);
                   hideSearchResult();
               }
           },
           error: function() {
               alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
   function showSearchResult(user) {
       $('#searchedUserName').text(user.userName);
       $('#searchedUserNickname').text(user.nickName);
       $('#searchResult').addClass('show');
   }

   // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
   function hideSearchResult() {
       $('#searchResult').removeClass('show');
   }

   // ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°
   function sendFriendRequest() {
       const targetUser = $('#searchedUserName').text();
       
       $.ajax({
           url: '/friend/request',
           type: 'POST',
           data: { targetUserName: targetUser },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   hideSearchResult();
                   $('#friendSearchInput').val('');
               }
           },
           error: function() {
               alert('ì¹œêµ¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ì¹œêµ¬ ë°ì´í„°ë¥¼ Ajaxë¡œ ì‹¤ì‹œê°„ ë¡œë“œ
   function loadFriendData() {
       $.ajax({
           url: '/friend/notifications',
           type: 'GET',
           success: function(response) {
               if (response.success) {
                   updateFriendList(response.friendList || []);
                   updateRequestList(response.friendRequests || []);
                   updateInviteList(response.gameInvites || []);
               }
           },
           error: function() {
               console.log('ì¹œêµ¬ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
               // ì˜¤ë¥˜ ì‹œ ê¸°ì¡´ Thymeleaf ë°ì´í„° ì‚¬ìš©
               loadFriendListFallback();
               loadFriendRequestsFallback();
               loadGameInvitesFallback();
           }
       });
   }

   // ì¹œêµ¬ ëª©ë¡ ì—…ë°ì´íŠ¸
   function updateFriendList(friendList) {
       $('#friendList').empty();
       $('#friendCount').text(friendList.length);
       
       if (friendList.length === 0) {
           $('#friendsEmpty').show();
           return;
       }
       
       $('#friendsEmpty').hide();
       friendList.forEach(function(friend) {
           const friendItem = createFriendItem(friend);
           $('#friendList').append(friendItem);
       });
   }

   // ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
   function updateRequestList(friendRequests) {
       $('#requestList').empty();
       $('#requestCount').text(friendRequests.length);
       
       if (friendRequests.length === 0) {
           $('#requestsEmpty').show();
           return;
       }
       
       $('#requestsEmpty').hide();
       friendRequests.forEach(function(request) {
           const requestItem = createRequestItem(request);
           $('#requestList').append(requestItem);
       });
   }

   // ê²Œì„ ì´ˆëŒ€ ëª©ë¡ ì—…ë°ì´íŠ¸
   function updateInviteList(gameInvites) {
       $('#inviteList').empty();
       $('#inviteCount').text(gameInvites.length);
       
       if (gameInvites.length === 0) {
           $('#invitesEmpty').show();
           return;
       }
       
       $('#invitesEmpty').hide();
       gameInvites.forEach(function(invite) {
           const inviteItem = createInviteItem(invite);
           $('#inviteList').append(inviteItem);
       });
   }

   // ë°±ì—…ìš© Thymeleaf ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤
   function loadFriendListFallback() {
       const friendList = /*[[${friendList}]]*/ [];
       updateFriendList(friendList);
   }

   function loadFriendRequestsFallback() {
       const friendRequests = /*[[${friendRequests}]]*/ [];
       updateRequestList(friendRequests);
   }

   function loadGameInvitesFallback() {
       const gameInvites = /*[[${gameInvites}]]*/ [];
       updateInviteList(gameInvites);
   }

   // ì¹œêµ¬ ì•„ì´í…œ ìƒì„±
   function createFriendItem(friend) {
       return $(`
           <li class="friend-item">
               <div class="friend-avatar">
                   ğŸ‘¤
                   <div class="online-status offline"></div>
               </div>
               <div class="friend-info">
                   <div class="friend-name">${friend.friendNickName || friend.friendUserName}</div>
                   <div class="friend-status">ì˜¤í”„ë¼ì¸</div>
               </div>
               <div class="friend-actions">
                   <button class="action-btn message-btn" onclick="sendMessage('${friend.friendUserName}')">ìª½ì§€</button>
                   <button class="action-btn invite-btn" onclick="inviteToGame('${friend.friendUserName}')">ì´ˆëŒ€</button>
                   <button class="action-btn remove-btn" onclick="removeFriend('${friend.friendUserName}')">ì‚­ì œ</button>
               </div>
           </li>
       `);
   }

   // ì¹œêµ¬ ìš”ì²­ ì•„ì´í…œ ìƒì„±
   function createRequestItem(request) {
       return $(`
           <li class="friend-item">
               <div class="friend-avatar">ğŸ‘¤</div>
               <div class="friend-info">
                   <div class="friend-name">${request.requesterNickName || request.requesterName}</div>
                   <div class="friend-status">ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤</div>
               </div>
               <div class="friend-actions">
                   <button class="action-btn accept-btn" onclick="acceptFriendRequest(${request.relationNo})">ìˆ˜ë½</button>
                   <button class="action-btn reject-btn" onclick="rejectFriendRequest(${request.relationNo})">ê±°ì ˆ</button>
               </div>
           </li>
       `);
   }

   // ê²Œì„ ì´ˆëŒ€ ì•„ì´í…œ ìƒì„±
   function createInviteItem(invite) {
       return $(`
           <li class="friend-item">
               <div class="friend-avatar">ğŸ®</div>
               <div class="friend-info">
                   <div class="friend-name">${invite.senderNickName || invite.senderName}</div>
                   <div class="friend-status">${invite.roomName}ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤</div>
               </div>
               <div class="friend-actions">
                   <button class="action-btn accept-btn" onclick="acceptGameInvite(${invite.inviteNo})">ìˆ˜ë½</button>
                   <button class="action-btn reject-btn" onclick="rejectGameInvite(${invite.inviteNo})">ê±°ì ˆ</button>
               </div>
           </li>
       `);
   }

   // ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½
   function acceptFriendRequest(relationNo) {
       $.ajax({
           url: '/friend/accept',
           type: 'POST',
           data: { relationNo: relationNo },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   loadFriendData();
               }
           },
           error: function() {
               alert('ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ
   function rejectFriendRequest(relationNo) {
       $.ajax({
           url: '/friend/reject',
           type: 'POST',
           data: { relationNo: relationNo },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   loadFriendData();
               }
           },
           error: function() {
               alert('ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ì¹œêµ¬ ì‚­ì œ
   function removeFriend(friendUserName) {
       if (!confirm('ì •ë§ë¡œ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
           return;
       }
       
       $.ajax({
           url: '/friend/delete',
           type: 'POST',
           data: { friendUserName: friendUserName },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   loadFriendData();
               }
           },
           error: function() {
               alert('ì¹œêµ¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ê²Œì„ ì´ˆëŒ€ ìˆ˜ë½
   function acceptGameInvite(inviteNo) {
       $.ajax({
           url: '/friend/invite/respond',
           type: 'POST',
           data: { 
               inviteNo: inviteNo,
               status: 'ACCEPTED'
           },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   loadFriendData();
                   // ê²Œì„ë°©ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
               }
           },
           error: function() {
               alert('ê²Œì„ ì´ˆëŒ€ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ê²Œì„ ì´ˆëŒ€ ê±°ì ˆ
   function rejectGameInvite(inviteNo) {
       $.ajax({
           url: '/friend/invite/respond',
           type: 'POST',
           data: { 
               inviteNo: inviteNo,
               status: 'REJECTED'
           },
           success: function(response) {
               alert(response.message);
               if (response.success) {
                   loadFriendData();
               }
           },
           error: function() {
               alert('ê²Œì„ ì´ˆëŒ€ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           }
       });
   }

   // ìª½ì§€ ë³´ë‚´ê¸° (ë¯¸êµ¬í˜„)
   function sendMessage(userName) {
	   window.location.href = '/message/write';
   }

   // ê²Œì„ ì´ˆëŒ€í•˜ê¸°
   function inviteToGame(userName) {
	   alert('í˜„ì¬ ê¸°ëŠ¥ êµ¬í˜„ì¤‘ ì«Œë§Œ ê¸°ë‹¤ë¦¬ì‚¼.');
/* 		
	   //ë°©ë²ˆí˜¸ ì…ë ¥
       const roomNo = prompt(`${userName}ë‹˜ì„ ê²Œì„ì— ì´ˆëŒ€í•˜ê¸°\n\nì´ˆëŒ€í•  ê²Œì„ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
       
       if (!roomNo) {
           return; // ì·¨ì†Œ
       }
       
       if (isNaN(roomNo) || roomNo <= 0) {
           alert('ì˜¬ë°”ë¥¸ ë°©ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
           return;
       }
       
       // í™•ì¸ ë©”ì‹œì§€
       if (!confirm(`${userName}ë‹˜ì„ ${roomNo}ë²ˆ ë°©ì— ì´ˆëŒ€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
           return;
       }
       
       // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
       const inviteButtons = $('button[onclick*="inviteToGame"]');
       inviteButtons.prop('disabled', true).text('ì´ˆëŒ€ì¤‘...');
       
       $.ajax({
           url: '/friend/invite',
           type: 'POST',
           data: { 
               inviteUserName: userName,
               roomNo: parseInt(roomNo)
           },
           success: function(response) {
               if (response.success) {
                   alert('âœ… ' + response.message);
               } else {
                   alert('âŒ ' + response.message);
               }
           },
           error: function(xhr, status, error) {
               console.error('ê²Œì„ ì´ˆëŒ€ ì˜¤ë¥˜:', error);
               alert('âŒ ê²Œì„ ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
           },
           complete: function() {
               // ë²„íŠ¼ ìƒíƒœ ë³µì›
               inviteButtons.prop('disabled', false).text('ì´ˆëŒ€');
           }
       }); */
   }
</script>
</body>
</html>